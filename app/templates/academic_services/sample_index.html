{% extends "academic_services/service_base.html" %}
{% block title %}MUMT-MIS: Academic Service{% endblock %}
{% block head %}
    {{ super() }}
    <link href="https://cdn.jsdelivr.net/gh/octoshrimpy/bulma-o-steps@master/bulma-steps.css" rel="stylesheet"/>
    <link href="https://fastly.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.css" rel="stylesheet"/>
    <style>
        .toast {
            opacity: 1 !important;
            transition: none !important;
        }

        #toast-container.toast-top-full-width > .toast {
            width: 100% !important;
        }

        .table-container {
            overflow-x: auto;
        }
    </style>
{% endblock %}
{% block page_content %}
    {% include "academic_services/customer_nav.html" %}
    <section class="section" id="sample">
        <div class="columns is-centered">
            {% include 'academic_services/menu.html' %}
            <div class="column is-9">
                <div class="column is-11">
                    <h1 class="title has-text-centered">นัดหมายส่งตัวอย่าง</h1>
                </div>
                <div class="tabs">
                    <ul>
                        <li {% if tab == 'schedule' %}class="is-active"{% endif %}>
                            <a href="{{ url_for('academic_services.sample_index', tab='schedule', menu=menu) }}">
                                <span class="icon is-small"><i class="fas fa-calendar"></i></span>
                                <span>ยังไม่ได้นัดหมาย</span>
                                {% if schedule_count > 0 %}
                                    <span class="tag is-danger is-rounded is-size-7 ml-1">{{ schedule_count }}</span>
                                {% endif %}
                            </a>
                        </li>
                        <li {% if tab == 'delivery' %}class="is-active"{% endif %}>
                            <a href="{{ url_for('academic_services.sample_index', tab='delivery', menu=menu) }}">
                                <span class="icon is-small"><i class="fas fa-shipping-fast"></i></span>
                                <span>รอส่งตัวอย่าง</span>
                                {% if delivery_count > 0 %}
                                    <span class="tag is-danger is-rounded is-size-7 ml-1">{{ delivery_count }}</span>
                                {% endif %}
                            </a>
                        </li>
                        <li {% if tab == 'received' %}class="is-active"{% endif %}>
                            <a href="{{ url_for('academic_services.sample_index', tab='received', menu=menu) }}">
                                <span class="icon is-small"><i class="fa fa-check"></i></span>
                                <span>ส่งตัวอย่างแล้ว</span>
                            </a>
                        </li>
                        <li {% if tab == 'all' %}class="is-active"{% endif %}>
                            <a href="{{ url_for('academic_services.sample_index', tab='all', menu=menu) }}">
                                <span class="icon is-small"><i class="fas fa-list-ul"></i></span>
                                <span>ทั้งหมด</span>
                            </a>
                        </li>
                    </ul>
                </div>
                <div class="table-container">
                    <table id='samples' class="table is-fullwidth is-striped">
                        <thead>
                        <th>เลขใบคำร้องขอ</th>
                        <th>หมายเลขติดตามพัสดุ</th>
                        <th>วัน-เวลาที่นัดหมาย</th>
                        <th>วัน-เวลาที่รับ</th>
                        <th>สถานที่</th>
                        <th>การส่งตัวอย่าง</th>
                        <th>สภาพตัวอย่าง</th>
                        <th>เอกสาร</th>
                        <th>หมายเหตุ</th>
                        <th>ใบนำส่งตัวอย่าง</th>
                        <th>สถานะ</th>
                        <th></th>
                        </thead>
                        <tbody>
                        {% for sample in samples|sort(attribute='created_at', reverse = True) %}
                            <tr>
                                <td>{{ sample.request.request_no }}</td>
                                <td>
                                    <div id="tracking_number"></div>
                                    {% if sample.ship_type == 'ส่งทางไปรษณีย์' and not sample.tracking_number %}
                                        <div class="field has-addons">
                                            <div class="control">
                                                <a class="button is-small is-info is-outlined is-rounded"
                                                   hx-swap="innerHTML"
                                                   hx-target="#tracking_number"
                                                   hx-get="{{ url_for('academic_services.add_tracking_number',
                                                                   sample_id=sample.id, menu=menu, tab=tab) }}">
                                                    <span class="icon"><i class="fas fa-plus"></i></span>
                                                    <span>เพิ่ม</span>
                                                </a>
                                            </div>
                                        </div>
                                    {% elif sample.tracking_number and not sample.received_at %}
                                        <span>{{ sample.tracking_number }}</span>
                                        <span>
                                            <a hx-swap="innerHTML"
                                               hx-target="#tracking_number"
                                               hx-get="{{ url_for('academic_services.add_tracking_number',
                                               sample_id=sample.id, menu=menu, tab=tab) }}">
                                                <span class="icon">
                                                    <i class="fas fa-pen"></i>
                                                </span>
                                            </a>
                                        </span>
                                    {% else %}
                                        {{ sample.tracking_number or '' }}
                                    {% endif %}
                                </td>
                                <td>
                                    {% if sample.appointment_date %}
                                        {{ sample.appointment_date.strftime('%d/%m/%Y') }}
                                    {% else %}
                                        {{ '' }}
                                    {% endif %}
                                </td>
                                <td>{{ sample.received_at|localdatetime or '' }}</td>
                                <td>{{ sample.location_name or '' }}</td>
                                <td>{{ sample.ship_type or '' }}</td>
                                <td>
                                    {% if sample.received_at %}
                                        <span class="tag {{ sample.sample_condition_status_color }}">
                                            {{ sample.sample_condition_status }}
                                        </span>
                                    {% else %}
                                        <span class="tag is-danger">
                                            ยังไม่ได้ส่งตัวอย่าง
                                        </span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if sample.received_at %}
                                        <span class="tag {{ sample.get_file.color }}">
                                            {{ sample.get_file.status }}
                                        </span>
                                    {% else %}
                                        <span class="tag is-danger">
                                            ยังไม่ได้ส่งเอกสาร
                                        </span>
                                    {% endif %}
                                </td>
                                <td>{{ sample.note or '' }}</td>
                                <td>
                                    <div class="field has-addons">
                                        <div class="control">
                                            <a class="button is-rounded is-outlined is-small is-fullwidth mb-2"
                                               @click="printRequest({{ sample.request_id }})"
                                            >
                                                <span class="icon"><i class="fas fa-print"></i></span>
                                                <span>พิมพ์ใบนำส่งตัวอย่าง</span>
                                            </a>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <ul class="steps">
                                        <li class="steps-segment {% if not sample.appointment_date and not sample.tracking_number %} is-active {% endif %}">
                                            <span class="steps-marker">
                                                <span class="icon">
                                                    <i class="fas fa-calendar"></i>
                                                </span>
                                            </span>
                                            <div class="steps-content">
                                                <p>ยังไม่ได้นัดหมายส่งตัวอย่าง</p>
                                            </div>
                                        </li>
                                        <li class="steps-segment {% if (sample.appointment_date or sample.tracking_number) and not sample.received_at %} is-active {% endif %}">
                                            <span class="steps-marker">
                                                <span class="icon">
                                                    <i class="fas fa-shipping-fast"></i>
                                                </span>
                                            </span>
                                            <div class="steps-content">
                                                <p>รอส่งตัวอย่าง</p>
                                            </div>
                                        </li>
                                        <li class="steps-segment {% if sample.received_at %} is-active {% endif %}">
                                            <span class="steps-marker">
                                                <span class="icon">
                                                    <i class="fa fa-check"></i>
                                                </span>
                                            </span>
                                            <div class="steps-content">
                                                <p>ส่งตัวอย่างแล้ว</p>
                                            </div>
                                        </li>
                                    </ul>
                                </td>
                                <td>
                                    {% if not sample.received_at %}
                                        <div id="create_sample_appointment"></div>
                                        <div class="field has-addons">
                                            <div class="control">
                                                <a {% if sample.location %}
                                                    class="button is-small is-warning is-outlined is-rounded"
                                                {% else %}
                                                    class="button is-small is-info is-outlined is-rounded"
                                                {% endif %}
                                                    href="{{ url_for('academic_services.create_sample_appointment',
                                                               sample_id=sample.id, menu=menu, tab=tab) }}">
                                                    {% if sample.location %}
                                                        <span class="icon"><i class="fas fa-pen"></i></span>
                                                        <span>แก้ไขการนัดหมาย</span>
                                                    {% else %}
                                                        <span class="icon"><i class="fas fa-plus"></i></span>
                                                        <span>เพิ่มการนัดหมาย</span>
                                                    {% endif %}
                                                </a>
                                            </div>
                                            <div class="control">
                                                <a class="button is-small is-primary is-outlined is-rounded"
                                                   href="{{ url_for('academic_services.view_sample_appointment',
                                                                   sample_id=sample.id, menu=menu, tab=tab) }}">
                                                    <span class="icon"><i class="fas fa-eye"></i></span>
                                                    <span>รายละเอียด</span>
                                                </a>
                                            </div>
                                        </div>
                                    {% else %}
                                        <div class="field has-addons">
                                            <div class="control">
                                                <a class="button is-small is-primary is-outlined is-rounded"
                                                   href="{{ url_for('academic_services.view_sample_appointment',
                                                                   sample_id=sample.id, menu=menu, tab=tab) }}">
                                                    <span class="icon"><i class="fas fa-eye"></i></span>
                                                    <span>รายละเอียด</span>
                                                </a>
                                            </div>
                                        </div>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </section>
{% endblock %}
{% block scripts %}
    {{ super() }}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.0.943/pdf.min.js"></script>
    <script src="https://fastly.jsdelivr.net/npm/toastr@2.1.4/build/toastr.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#samples').DataTable({});
        });
    </script>
    <script type="text/javascript">
        var vm = new Vue({
            el: "#sample",
            delimiters: ['<%', '%>'],
            methods: {
                printRequest: function (request_id) {
                    var url = "/academic_services/request/pdf/" + request_id;
                    printJS(url);
                }
            },
        });
    </script>
    <script>
        function showToast(category, message) {
            toastr.options = {
                "closeButton": false,
                "debug": false,
                "newestOnTop": false,
                "progressBar": false,
                "positionClass": "toast-top-full-width",
                "preventDuplicates": false,
                "onclick": null,
                "showEasing": "swing",
                "hideEasing": "linear",
                "showMethod": "fadeIn",
                "hideMethod": "fadeOut"
            };
            if (category === 'success') {
                toastr.success(message);
            } else if (category === 'danger') {
                toastr.error(message);
            } else if (category === 'warning') {
                toastr.warning(message);
            } else {
                toastr.info(message);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        showToast('{{ category }}', {{ message|tojson }});
                    {% endfor %}
                {% endif %}
            {% endwith %}
        });
    </script>
{% endblock %}
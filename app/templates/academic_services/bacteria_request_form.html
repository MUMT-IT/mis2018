{% extends "academic_services/service_base.html" %}
{% block head %}
    {{ super() }}
    <link rel="stylesheet" type="text/css" href="https://fastly.jsdelivr.net/npm/daterangepicker/daterangepicker.css"
          xmlns="http://www.w3.org/1999/html"/>
{% endblock %}
{% block page_content %}
    {% include "academic_services/customer_nav.html" %}\
    {% include 'messages.html' %}
    <div class="container is-max-widescreen">
        <div class="box p-6 has-background-white rounded-xl shadow-lg">
            <h1 class="title is-3 has-text-centered has-text-grey-dark">ฟอร์มบันทึกข้อมูล Lab</h1>

            <form id="labDataForm" method="post">
                {{ form.hidden_tag() }}
                <!-- Product Information Section -->
                <div class="card mb-5">
                    <header class="card-header has-background-light">
                        <p class="card-header-title has-text-grey-darker">
                            ข้อมูลผลิตภัณฑ์
                        </p>
                    </header>
                    <div class="card-content">
                        <div class="content">
                            <div class="columns is-multiline">
                                <div class="column is-half">
                                    <div class="field">
                                        <label class="label">
                                            {{ form.sample_name.label }}
                                            <span class="has-text-danger">*</span>
                                        </label>
                                        <div class="control">
                                            {{ form.sample_name(class='input') }}
                                        </div>
                                    </div>
                                </div>
                                <div class="column is-half">
                                    <div class="field">
                                        <label class="label">
                                            {{ form.active_substance.label }}
                                            <span class="has-text-danger">*</span>
                                        </label>
                                        <div>
                                            {{ form.active_substance(class='textarea', placeholder='เช่น Formaldyhyde 37% w/w, Ethyl Alcohol 50% w/w') }}
                                        </div>
                                    </div>
                                </div>
                                <div class="column is-half">
                                    <div class="field">
                                        <label class="label">
                                            {{ form.product_appearance.label }}
                                            <span class="has-text-danger">*</span>
                                        </label>
                                        <div class="control">
                                            {{ form.product_appearance(class='input') }}
                                        </div>
                                    </div>
                                </div>
                                <div class="column is-half">
                                    <div class="field">
                                        <label class="label">
                                            {{ form.kind.label }}
                                            <span class="has-text-danger">*</span>
                                        </label>
                                        <div class="control">
                                            {{ form.kind(class='input') }}
                                        </div>
                                    </div>
                                </div>
                                <div class="column is-half">
                                    <div class="field">
                                        <label class="label">{{ form.size.label }}
                                            <span class="has-text-danger">*</span>
                                        </label>
                                        <div class="control">
                                            {{ form.size(class='input') }}
                                        </div>
                                    </div>
                                </div>
                                <div class="column is-half">
                                    <div class="field">
                                        <label class="label">
                                            {{ form.mfg.label }}
                                            <span class="has-text-danger">*</span></label>
                                        <div class="control">
                                            {{ form.mfg(class='input') }}
                                        </div>
                                    </div>
                                </div>
                                <div class="column is-half">
                                    <div class="field">
                                        <label class="label">
                                            {{ form.exp.label }}
                                            <span class="has-text-danger">*</span>
                                        </label>
                                        <div class="control">
                                            {{ form.exp(class='input') }}
                                        </div>
                                    </div>
                                </div>
                                <div class="column is-half">
                                    <div class="field">
                                        <label class="label">
                                            {{ form.lot_no.label }}
                                            <span class="has-text-danger">*</span>
                                        </label>
                                        <div class="control">
                                            {{ form.lot_no(class='input') }}
                                        </div>
                                    </div>
                                </div>
                                <div class="column is-half">
                                    <div class="field">
                                        <label class="label">
                                            {{ form.manufacturer.label }}
                                            <span class="has-text-danger">*</span>
                                        </label>
                                        <div class="control">
                                            {{ form.manufacturer(class='input') }}
                                        </div>
                                    </div>
                                </div>
                                <div class="column is-half">
                                    <div class="field">
                                        <label class="label">
                                            {{ form.manufacturer_address.label }}
                                            <span class="has-text-danger">*</span>
                                        </label>
                                        <div class="control">
                                            {{ form.manufacturer_address(class='textarea') }}
                                        </div>
                                    </div>
                                </div>
                                <div class="column is-half">
                                    <div class="field">
                                        <label class="label">
                                            {{ form.importanddistributor.label }}
                                            <span class="has-text-danger">*</span>
                                        </label>
                                        <div class="control">
                                            {{ form.importanddistributor(class='input') }}
                                        </div>
                                    </div>
                                </div>
                                <div class="column is-half">
                                    <div class="field">
                                        <label class="label">
                                            {{ form.importanddistributor_address.label }}
                                            <span class="has-text-danger">*</span>
                                        </label>
                                        <div class="control">
                                            {{ form.importanddistributor_address(class='textarea') }}
                                        </div>
                                    </div>
                                </div>
                                <div class="column is-half">
                                    <div class="field">
                                        <label class="label">
                                            {{ form.amount.label }}
                                            <span class="has-text-danger">*</span>
                                        </label>
                                        <div class="control">
                                            {{ form.amount(class='input') }}
                                        </div>
                                    </div>
                                </div>
                                <div class="column is-half">
                                    <div class="field">
                                        <label class="label">
                                            {{ form.collect_samples_during_testing.label }}
                                            <span class="has-text-danger">*</span>
                                        </label>
                                        <div class="select">
                                            {{ form.collect_samples_during_testing() }}
                                        </div>
                                    </div>
                                </div>
                                <div class="column is-half is-hidden"
                                     id="other_collect_samples_container">
                                    <div class="field">
                                        <label class="label">{{ form.collect_samples_during_testing_other.label }}</label>
                                        <div class="control">
                                            {{ form.collect_samples_during_testing_other(class='input') }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Test Items Section -->
                <div class="card mb-5">
                    <header class="card-header has-background-light">
                        <p class="card-header-title has-text-grey-darker">
                            รายการทดสอบ
                        </p>
                    </header>
                    <div class="card-content">
                        <div class="content">
                            <div class="field">
                                <label class="label">
                                    {{ form.product_type.label }}
                                </label>
                                <div class="select">
                                    {{ form.product_type() }}
                                </div>
                            </div>
                            <div id="bacteria_section" class="field is-hidden">
                                {% for item_form in form.items %}
                                    <label class="label">{{ item_form.liquid_test_method.label }}</label>
                                    {% for subfield in item_form.liquid_test_method %}
                                        <label class="checkbox">
                                            {{ subfield() }} {{ subfield.label.text }}
                                        </label><br/>
                                    {% endfor %}
                                    <div class="field">
                                        <label class="label">{{ item_form.liquid_dilution.label }}</label>
                                        <div class="select">
                                            {{ item_form.liquid_dilution() }}
                                        </div>
                                    </div>
                                    <div class="field">
                                        <label class="label">{{ item_form.liquid_germ.label }}</label>
                                        <div class="select">
                                            {{ item_form.liquid_germ() }}
                                        </div>
                                    </div>
                                    <div class="field">
                                        <label class="label">{{ item_form.liquid_ratio.label }}</label>
                                        <div class="control">
                                            {{ item_form.liquid_ratio(class='input') }}
                                        </div>
                                    </div>
                                    <div class="field">
                                        <label class="label">{{ item_form.liquid_per_water.label }}</label>
                                        <div class="control">
                                            {{ item_form.liquid_per_water(class='input') }}
                                        </div>
                                    </div>
                                    <div class="field">
                                        <label class="label">{{ item_form.liquid_time_duration.label }}</label>
                                        <div class="control">
                                            {{ item_form.liquid_time_duration(class='input') }}
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="field is-grouped is-justify-content-center">
                    <div class="control">
                        <input type="submit" value="Submit" class="button is-success">
                    </div>
                </div>
            </form>

            <!-- JSON Output Section -->
            <div id="jsonOutput" class="box is-hidden mt-5 has-background-light">
                <h2 class="title is-4 has-text-grey-darker">ข้อมูล JSON ที่สร้างขึ้น</h2>
                <pre id="jsonContent"
                     class="has-background-grey-darker has-text-white p-4 rounded-lg text-sm is-fullwidth"></pre>
            </div>

            <!-- Alert Modal -->
            <div id="alertModal" class="modal">
                <div class="modal-background"></div>
                <div class="modal-content">
                    <div class="box has-text-centered">
                        <h3 class="title is-5">เกิดข้อผิดพลาด</h3>
                        <p class="subtitle is-6" id="alertMessage">
                            โปรดกรอกข้อมูลที่จำเป็นให้ครบถ้วน</p>
                        <div class="buttons is-centered mt-4">
                            <button id="closeAlert"
                                    class="button is-info">ตกลง
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block scripts %}
    {{ super() }}
    <script type="text/javascript" src="https://fastly.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script>
    $(document).ready(function () {
            moment.locale('th');
            $('input[name="mfg"]').daterangepicker({
                singleDatePicker: true,
                timePicker: true,
                timePickerIncrement: 15,
                timePicker24Hour: true,
                showDropdowns: true,
                autoUpdateInput: true,

                startDate: moment().startOf('hour').add(1, 'hours'),
                locale: {
                    format: 'YYYY-MM-DD'
                }
            });
            $('input[name="exp"]').daterangepicker({
                singleDatePicker: true,
                timePicker: true,
                timePickerIncrement: 15,
                timePicker24Hour: true,
                showDropdowns: true,
                autoUpdateInput: true,
                startDate: moment().startOf('hour').add(2, 'hours'),
                locale: {
                    format: 'YYYY-MM-DD'
                }
            });
        })
    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            {#const form = document.getElementById('labDataForm');#}
            const jsonOutputDiv = document.getElementById('jsonOutput');
            const jsonContentPre = document.getElementById('jsonContent');
            const collectSamplesDuringTesting = document.getElementById('collect_samples_during_testing');
            const otherCollectSamplesContainer = document.getElementById('other_collect_samples_container');
            const productType = document.getElementById('product_type');
            const bacteriaSection = document.getElementById('bacteria_section');
            const alertModal = document.getElementById('alertModal');
            const alertMessage = document.getElementById('alertMessage');
            const closeAlertBtn = document.getElementById('closeAlert');

            // Show/hide other field for sample collection
            collectSamplesDuringTesting.addEventListener('change', (e) => {
                if (e.target.value === "อื่นๆ โปรดระบุ") {
                    otherCollectSamplesContainer.classList.remove('is-hidden');
                } else {
                    otherCollectSamplesContainer.classList.add('is-hidden');
                }
            });

            // Show/hide sections based on product type
            productType.addEventListener('change', (e) => {
                if (e.target.value === "ผลิตภัณฑ์ฆ่าเชื้อบนพื้นผิวไม่มีรูพรุนชนิดของเหลว หรือชนิดผง ที่ละลายน้้าได้") {
                    bacteriaSection.classList.remove('is-hidden');
                }
            });

            {#form.addEventListener('submit', (e) => {#}
            {#    e.preventDefault();#}
            {##}
            {#    // Collect form data#}
            {#    const formData = new FormData(form);#}
            {#    const data = {};#}
            {#    for (const [key, value] of formData.entries()) {#}
            {#        if (value) {#}
            {#            data[key] = value;#}
            {#        }#}
            {#    }#}
            {##}
            {#    // Simple validation for required fields#}
            {#    const requiredFields = ["sample_name", "product_appearance", "size", "mfg", "exp", "lot_no", "manufacturer", "amount", "collect_samples_during_testing"];#}
            {#    for (const field of requiredFields) {#}
            {#        if (!data[field]) {#}
            {#            showAlert("โปรดกรอกข้อมูลที่จำเป็นให้ครบถ้วน");#}
            {#            return;#}
            {#        }#}
            {#    }#}
            {##}
            {#    // Validate specific fields based on product type#}
            {#    if (data.product_type === "ผลิตภัณฑ์ฆ่าเชื้อที่ใช้ในกระบวนการซักผ้า") {#}
            {#        if (!data.while_wash_test_method || !data.while_wash_dilution || !data.while_wash_germ) {#}
            {#            showAlert("โปรดกรอกข้อมูลการทดสอบ In Wash ให้ครบถ้วน");#}
            {#            return;#}
            {#        }#}
            {#        if (!data.after_wash_ratio_and_per_water || !data.after_wash_time_duration) {#}
            {#            showAlert("โปรดกรอกข้อมูลการทดสอบ After Wash ให้ครบถ้วน");#}
            {#            return;#}
            {#        }#}
            {#    }#}
            {##}
            {#    // Simulate the call to the Python backend (views.py)#}
            {#    // In a real app, you would send this data to a server endpoint.#}
            {#    // For this example, we'll just process it directly in JS.#}
            {#    const processedData = processFormSubmission(data);#}
            {##}
            {#    // Display the result#}
            {#    jsonContentPre.textContent = processedData;#}
            {#    jsonOutputDiv.classList.remove('is-hidden');#}
            {##}
            {#    // Scroll to the result section#}
            {#    jsonOutputDiv.scrollIntoView({behavior: 'smooth'});#}
            {##}

            // Simulating the Python backend logic from views.py and models.py
            {#function processFormSubmission(formDataRaw) {#}
            {#    const processedData = formDataRaw;#}
            {#    return JSON.stringify(processedData, null, 4);#}
           {##}
            {##}
            {#function showAlert(message) {#}
            {#    alertMessage.textContent = message;#}
            {#    alertModal.classList.add('is-active');#}
         {##}
            {##}
            {#closeAlertBtn.addEventListener('click', () => {#}
            {#    alertModal.classList.remove('is-active');#}
            {##}
        });
    </script>
{% endblock %}
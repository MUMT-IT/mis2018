{% extends "academic_services/service_base.html" %}
{% block head %}
    {{ super() }}
    <link rel="stylesheet" type="text/css" href="https://fastly.jsdelivr.net/npm/daterangepicker/daterangepicker.css"/>
    <style>
        table {
            width: 100%;
            table-layout: fixed;
        }
        th, td {
            padding: 5px;
        }
        .daterangepicker td,
        .daterangepicker th {
            display: table-cell !important;
        }
    </style>
{% endblock %}
{% from "academic_services/bacteria/macros/organism_form_field_macro.html" import organism_form_field %}
{% block page_content %}
    {% include "academic_services/customer_nav.html" %}
    {% include 'messages.html' %}
    <div class="container is-max-widescreen">
        <div class="column">
            <h1 class="title is-3 has-text-centered has-text-grey-dark">ฟอร์ม{{ sub_lab.sub_lab }}</h1>
            <form method="post">
                {{ form.hidden_tag() }}
                <div class="card mb-5">
                    <header class="card-header has-background-light">
                        <p class="card-header-title has-text-grey-darker">
                            ข้อมูลผลิตภัณฑ์
                        </p>
                    </header>
                    <div class="card-content">
                        <div class="content">
                            <div class="field">
                                <label class="label">{{ form.sample_name.label }}</label>
                                <div class="control">
                                    {{ form.sample_name(class='input') }}
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">{{ form.active_substance.label }}</label>
                                <div class="control">
                                    {{ form.active_substance(class='textarea') }}
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">{{ form.product_appearance.label }}</label>
                                <div class="control">
                                    {{ form.product_appearance(class='input') }}
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">{{ form.kind.label }}</label>
                                <div class="contol">
                                    {{ form.kind(class='input') }}
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">{{ form.size.label }}</label>
                                <div class="control">
                                    {{ form.size(class='input') }}
                                </div>
                            </div>
                            <div class="field">
                                <div class="field-body">
                                    <div class="field">
                                        <label class="label">{{ form.mfg.label }}</label>
                                        <div class="control">
                                            {{ form.mfg(class='input') }}
                                        </div>
                                    </div>
                                    <div class="field">
                                        <label class="label">{{ form.exp.label }}</label>
                                        <div class="control">
                                            {{ form.exp(class='input') }}
                                        </div>
                                    </div>
                                    <div class="field">
                                        <label class="label">{{ form.lot_no.label }}</label>
                                        <div class="control">
                                            {{ form.lot_no(class='input') }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">{{ form.manufacturer.label }}</label>
                                <div class="control">
                                    {{ form.manufacturer(class='input') }}
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">{{ form.manufacturer_address.label }}</label>
                                <div class="control">
                                    {{ form.manufacturer_address(class='textarea') }}
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">{{ form.importanddistributor.label }}</label>
                                <div class="control">
                                    {{ form.importanddistributor(class='input') }}
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">{{ form.importanddistributor_address.label }}</label>
                                <div class="control">
                                    {{ form.importanddistributor_address(class='textarea') }}
                                </div>
                            </div>
                            <div class="field">
                                <div class="field-body">
                                    <div class="field">
                                        <label class="label">{{ form.amount.label }}</label>
                                        <div class="control">
                                            {{ form.amount(class='input') }}
                                        </div>
                                    </div>
                                    <div class="field">
                                        <label class="label">{{ form.collect_sample_during_testing.label }}</label>
                                        <div class="select is-fullwidth">
                                            {{ form.collect_sample_during_testing(
                                                **{'hx-get': url_for("academic_services.get_collect_sample_during_testing",
                                                request_id=request_id),
                                                'hx-target': '#collect-samples-other-container',
                                                 'hx-swap': 'innerHTML',
                                                 'hx-trigger': 'change, load'}) }}
                                        </div>
                                    </div>
                                    <div id="collect-samples-other-container" style='width:55%'>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card mb-5">
                    <header class="card-header has-background-light" style="display: flex; justify-content: space-between;
                    align-items: center;">
                        <p class="card-header-title has-text-grey-darker" style="margin: 0;">
                            รายการทดสอบ
                        </p>
                        <div style="display: flex; justify-content: center; align-items: center;">
                            <div class="select">
                                {{ form.product_type(
                                **{'hx-get': url_for("academic_services.get_condition_form", code=code),
                                'hx-target': '#condition-fields',
                                 'hx-swap': 'beforeend',
                                 'hx-trigger': 'change, load'}) }}
                            </div>
                        </div>
                    </header>
                    <div class="card-content">
                        {% if request_id %}
                            <div class="field">
                                <div class="field">
                                    <label class="label">
                                        {{ form.label }}
                                    </label>
                                </div>
                                {% for subform in form %}
                                    {% if subform.type == 'FormField' %}
                                        {% set ns = namespace(has_value=false) %}
                                        {% for key, value in subform.data.items() %}
                                            {% if key != 'product_type' and key != 'csrf_token' %}
                                                {% if value and value is not mapping %}
                                                    {% set ns.has_value = true %}
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                        {% if ns.has_value %}
                                            <div class="card mb-2 subform-card">
                                                <div class="card-content">
                                                    <div class="field">
                                                        <label class="label">{{ subform.label.text }}</label>
                                                        {% for sf in subform if sf.type != 'HiddenField' and sf.type != 'CSRFTokenField' %}
                                                            <div class="field">
                                                                {{ sf() }}
                                                            </div>
                                                        {% endfor %}
                                                    </div>
                                                    <button
                                                        type="button"
                                                        class="button is-danger is-rounded is-small remove-subform"
                                                        data-request-id="{{ request_id or '' }}"
                                                        hx-post="{{ url_for('academic_services.remove_condition_form', request_id=request_id) }}"
                                                        hx-vals='{"field": "{{ subform.name }}"}'
                                                        hx-target="closest .subform-card"
                                                        hx-swap="innerHTML"
                                                    >
                                                        ลบ
                                                    </button>
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endif %}
                        <div class="field">
                            <div id="condition-fields"></div>
                        </div>
                    </div>
                </div>
                <div class="field is-grouped is-justify-content-center">
                    <div class="control">
                        <input type="submit" value="บันทึกและดำเนินการต่อ" class="button is-success">
                    </div>
                </div>
            </form>
        </div>
    </div>
{% endblock %}
{% block scripts %}
    {{ super() }}
    <script type="text/javascript"
            src="https://fastly.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script>
        $(document).ready(function () {
            moment.locale('th');
            $('input[name="mfg"]').daterangepicker({
                singleDatePicker: true,
                timePicker: true,
                timePickerIncrement: 15,
                timePicker24Hour: true,
                autoUpdateInput: false,
                locale:
                    {
                        format: 'YYYY-MM-DD HH:mm:ss',
                        cancelLabel: 'Clear'
                    }
            });
            $('input[name="mfg"]').on('apply.daterangepicker', function (ev, picker) {
                $(this).val(picker.startDate.format('YYYY-MM-DD HH:mm:ss'));
            });
            $('input[name="mfg"]').on('cancel.daterangepicker', function () {
                $(this).val('');
            });
            $('input[name="exp"]').daterangepicker({
                singleDatePicker: true,
                timePicker: true,
                timePickerIncrement: 15,
                timePicker24Hour: true,
                autoUpdateInput: false,
                locale:
                    {
                        format: 'YYYY-MM-DD HH:mm:ss',
                        cancelLabel: 'Clear'
                    }
            });
            $('input[name="exp"]').on('apply.daterangepicker', function (ev, picker) {
                $(this).val(picker.startDate.format('YYYY-MM-DD HH:mm:ss'));
            });
            $('input[name="exp"]').on('cancel.daterangepicker', function () {
                $(this).val('');
            });
        })
    </script>
    <script>
        document.body.addEventListener('htmx:afterRequest', (e) => {
            const select = document.getElementById('product_type');
            if (select) {
                select.selectedIndex = 0;
            }
        });
    </script>
    <script>
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('remove-subform')) {
                const btn = e.target;
                const card = btn.closest('.subform-card');
                const requestId = btn.dataset.requestId;

                if (!requestId) {
                    card.remove();
                    e.preventDefault();
                }
            }
        });
    </script>
{% endblock %}
{% extends "base.html" %}
{% block head %}
    {{ super() }}
    <style>
        table {
            width: 100%;
            table-layout: fixed;
        }

        th, td {
            padding: 5px;
        }

        .daterangepicker td,
        .daterangepicker th {
            display: table-cell !important;
        }

        input[readonly] {
            background-color: #e9ecef !important;
            cursor: not-allowed;
        }
    </style>
{% endblock %}
{% block page_content %}
    {% include "service_admin/admin_nav.html" %}
    {% include 'messages.html' %}
    <section class="section">
        <div class="container">
            <div class="columns is-centered">
                <div class="column is-12">
                    <h1 class="title is-3 has-text-centered has-text-grey-dark">ฟอร์ม{{ sub_lab.sub_lab }}</h1>
                    <form method="post">
                        {{ form.hidden_tag() }}
                        <div class="box">
                            <h5 class="title is-size-5">ข้อมูลผลิตภัณฑ์</h5>
                            <hr style="background-color: gainsboro">
                            <div class="field">
                                <label class="label">
                                    {{ form.product_name.label }}
                                    <span class="has-text-danger">*</span>
                                </label>
                                <div class="control">
                                    {{ form.product_name(class='input') }}
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">
                                    {{ form.disinfection_system.label }}
                                    <span class="has-text-danger">*</span>
                                </label>
                                <div class="control">
                                    {{ form.disinfection_system(class='textarea') }}
                                </div>
                            </div>
                            <div class="field">
                                <div class="field-body">
                                    <div class="field">
                                        <label class="label">
                                            {{ form.model.label }}
                                            <span class="has-text-danger">*</span>
                                        </label>
                                        <div class="control">
                                            {{ form.model(class='input') }}
                                        </div>
                                    </div>
                                    <div class="field">
                                        <label class="label">
                                            {{ form.serial_no.label }}
                                            <span class="has-text-danger">*</span>
                                        </label>
                                        <div class="control">
                                            {{ form.serial_no(class='input') }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">
                                    {{ form.equipment_test_operation.label }}
                                    <span class="has-text-danger">*</span>
                                </label>
                                <div class="control">
                                    {{ form.equipment_test_operation(class='textarea') }}
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">
                                    {{ form.manufacturer.label }}
                                    <span class="has-text-danger">*</span>
                                </label>
                                <div class="control">
                                    {{ form.manufacturer(class='input') }}
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">
                                    {{ form.manufacturer_address.label }}
                                    <span class="has-text-danger">*</span>
                                </label>
                                <div class="control">
                                    {{ form.manufacturer_address(class='textarea') }}
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">
                                    {{ form.importer.label }}
                                </label>
                                <div class="control">
                                    {{ form.importer(class='input') }}
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">
                                    {{ form.importer_address.label }}
                                </label>
                                <div class="control">
                                    {{ form.importer_address(class='textarea') }}
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">
                                    {{ form.distributor.label }}
                                    <span class="has-text-danger">*</span>
                                </label>
                                <div class="control">
                                    {{ form.distributor(class='input') }}
                                </div>
                            </div>
                            <div class="field">
                                <label class="label">
                                    {{ form.distributor_address.label }}
                                    <span class="has-text-danger">*</span>
                                </label>
                                <div class="control">
                                    {{ form.distributor_address(class='textarea') }}
                                </div>
                            </div>
                        </div>
                        <div class="box">
                            <h5 class="title is-size-5">รายการทดสอบ</h5>
                            <hr style="background-color: gainsboro">
                            <div class="field">
                                <label class="label">
                                    {{ form.label }}
                                </label>
                            </div>
                            {% for subform in form %}
                                {% if subform.type == 'FormField' %}
                                    <div class="card subform-card mb-4" id="{{ subform.name }}">
                                        <header class="card-header">
                                            <p class="card-header-title">{{ subform.label }}</p>
                                        </header>
                                        <div class="card-content">
                                            {% for field in subform %}
                                                {% if field.type != 'HiddenField' and field.type != 'CSRFTokenField' %}
                                                    {% if field.type == 'FieldList' %}
                                                        <table class="table is-fullwidth ">
                                                            <thead>
                                                            {% for subfield in field %}
                                                                {% if loop.first %}
                                                                    {% for _field in subfield %}
                                                                        {% if _field.type != 'CSRFTokenField' %}
                                                                            <th style="border: none;width: 27em">
                                                                                {{ _field.label.text }}
                                                                                <span class="has-text-danger">*</span>
                                                                            </th>
                                                                        {% endif %}
                                                                    {% endfor %}
                                                                {% endif %}
                                                            {% endfor %}
                                                            </thead>
                                                            <tbody>
                                                                {% for subfield in field %}
                                                                    <tr>
                                                                        {% for _field in subfield %}
                                                                            {% if _field.type != 'CSRFTokenField' %}
                                                                                <td style="border: none">{{ _field() }}</td>
                                                                            {% endif %}
                                                                        {% endfor %}
                                                                        <td style="border: none">
                                                                            <a class="button is-danger is-outlined"
                                                                               hx-delete="{{ url_for('service_admin.remove_virus_surface_disinfection_organism_form_entry',
                                                                               name=subform.name) }}"
                                                                               hx-target="closest tr"
                                                                               hx-swap="outerHTML"
                                                                            >
                                                                                <span class="icon"><i class="fas fa-trash-alt"></i></span>
                                                                            </a>
                                                                        </td>
                                                                    </tr>
                                                                {% endfor %}
                                                                <tr>
                                                                    <td>
                                                                        <a class="button is-info is-outlined is-rounded"
                                                                           hx-post="{{ url_for('service_admin.add_virus_surface_disinfection_organism_form_entry') }}"
                                                                           hx-target="previous tr"
                                                                           hx-swap="afterend"
                                                                        >
                                                                            <span class="icon"><i class="fas fa-plus"></i></span>
                                                                            <span>เพิ่ม</span>
                                                                        </a>
                                                                    </td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    {% else %}
                                                        <div class="field">
                                                            <label class="label">
                                                                {{ field.label }}
                                                                <span class="has-text-danger">*</span>
                                                            </label>
                                                            <div class="control">
                                                                {{ field() }}
                                                            </div>
                                                        </div>
                                                    {% endif %}
                                                {% endif %}
                                            {% endfor %}
                                        </div>
                                    </div>
                                {% endif %}
                            {% endfor %}
                            <div class="field">
                                <div class="control">
                                    {{ form.read_document() }}
                                    {{ form.read_document.label }}
                                </div>
                            </div>
                        </div>
                        <div class="box">
                            <h5 class="title is-size-5">บันทึก/หมายเหตุ สำหรับผู้รับบริการ</h5>
                            <hr style="background-color: gainsboro">
                            <div class="field">
                                <label class="label">{{ form.note.label }}</label>
                                <div class="control">
                                    {{ form.note(class='textarea') }}
                                </div>
                            </div>
                        </div>
                        <div class="field is-grouped is-justify-content-center">
                            <div class="control">
                                <input type="submit" value="บันทึกและดำเนินการต่อ" class="button is-success">
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>
{% endblock %}
{% block scripts %}
    {{ super() }}
    <script>
        function toggleTable(subform) {
            const table = subform.find('table');
            const checkboxes = table.find('tbody tr input[type="checkbox"]');

            function validateInput() {
                const count = checkboxes.filter(':checked').length;
                if (count == 0) {
                    checkboxes.prop('required', true)
                    checkboxes.each(function () {
                        this.setCustomValidity('กรุณาเลือกเชื้ออย่างน้อย 1 รายการ');
                    });
                } else {
                    checkboxes.prop('required', false);
                    checkboxes.each(function () {
                        this.setCustomValidity('');
                    });
                }

                table.find('tbody tr').each(function () {
                    const checkbox = $(this).find('input[type="checkbox"]');
                    const textInputs = $(this).find('input[type="text"]');

                    const active = checkbox.is(':checked');
                    textInputs.each(function () {
                        const name = $(this).attr('name');
                        const isOptional = name.endsWith('ratio') || name.endsWith('per_water');

                        if (active && !isOptional) {
                            $(this)
                                .prop('required', true)
                                .attr('oninvalid', "this.setCustomValidity('กรุณากรอกข้อมูล')")
                                .attr('oninput', "this.setCustomValidity('')");
                        } else {
                            $(this).prop('required', false);
                            this.setCustomValidity('');
                        }

                        if (!active) {
                            $(this).val('');
                        }
                    })
                });
            }

            validateInput();

            checkboxes.on('change', validateInput);
        }

        function addRequiredField(subform) {
            const cleanTypeInput = subform.find('input[name$="clean_type"]');

            cleanTypeInput.prop('required', true)
                .attr('oninvalid', "this.setCustomValidity('กรุณาเลือกรูปแบบการทดสอบ')");

            cleanTypeInput.on('change', function () {
                cleanTypeInput.each(function () {
                    this.setCustomValidity('');
                });
            });
        }

        function showClenTypeOtherInput(subform) {
            const cleanTypeField = subform.find('input[type="radio"][name$="clean_type"]:checked').val();
            const cleanTypeOtherInput = subform.find('input[name$="clean_type_other"]');
            const cleanTypeOtherField = cleanTypeOtherInput.closest('.field');

            if (cleanTypeField && cleanTypeField.includes('อื่นๆ โปรดระบุ')) {
                cleanTypeOtherField.show();
                cleanTypeOtherInput.prop('required', true).attr('oninvalid', "this.setCustomValidity('กรุณากรอกรูปแบบการทดสอบ')")
                    .attr('oninput', "this.setCustomValidity('')");
            } else {
                cleanTypeOtherField.hide();
                cleanTypeOtherInput.val('');
            }
        }

        $('.subform-card').each(function () {
            const subform = $(this);
            toggleTable(subform);
            addRequiredField(subform);
            showClenTypeOtherInput(subform);
            subform.find('input[type="radio"][name$="clean_type"]').change(function () {
                showClenTypeOtherInput(subform);
            });
        });
    </script>
{% endblock %}
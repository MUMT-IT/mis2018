<div class="card subform-card mb-4" id="{{ fields.name }}">
    <header class="card-header">
        <p class="card-header-title">{{ fields.label }}</p>
    </header>
    <div class="card-content">
        {% for field in fields %}
            {% if field.type != 'HiddenField' and field.type != 'CSRFTokenField' %}
                {% if field.type == 'FieldList' %}
                    <table class="table is-fullwidth ">
                        <thead>
                        {% for subform in field %}
                            {% if loop.first %}
                                {% for _field in subform %}
                                    {% if _field.type != 'CSRFTokenField' %}
                                        {% if _field.type == 'SelectField' %}
                                            <th style="border: none; width: 16.5em">
                                                {% else %}
                                            <th style="border: none">
                                        {% endif %}
                                        {{ _field.label.text }}
                                        {% if _field.label.text != 'อัตราส่วนเจือจางผลิตภัณฑ์' and _field.label.text != 'ต่อน้ำ' %}
                                            <span class="has-text-danger">*</span>
                                        {% endif %}
                                    </th>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                        </thead>
                        <tbody>
                        {% for subform in field %}
                            <tr>
                                {% for _field in subform %}
                                    {% if _field.type != 'CSRFTokenField' %}
                                        <td style="border: none">
                                            {% if _field.type == 'SelectField' %}
                                                <div class="select">
                                                    {{ _field() }}
                                                </div>
                                            {% else %}
                                                {{ _field() }}
                                            {% endif %}
                                        </td>
                                    {% endif %}
                                {% endfor %}
                                <td style="border: none">
                                    {% if fields.name == 'liquid_condition_field' %}
                                        <a class="button is-danger is-outlined"
                                           hx-delete="{{ url_for('service_admin.remove_virus_liquid_organism_form_entry',
                                               name=subform.name) }}"
                                           hx-target="closest tr"
                                           hx-swap="outerHTML"
                                        >
                                            <span class="icon"><i class="fas fa-trash-alt"></i></span>
                                        </a>
                                    {% elif fields.name == 'spray_condition_field' %}
                                        <a class="button is-danger is-outlined"
                                           hx-delete="{{ url_for('service_admin.remove_virus_spray_organism_form_entry',
                                               name=subform.name) }}"
                                           hx-target="closest tr"
                                           hx-swap="outerHTML"
                                        >
                                            <span class="icon"><i class="fas fa-trash-alt"></i></span>
                                        </a>
                                    {% else %}
                                        <a class="button is-danger is-outlined"
                                           hx-delete="{{ url_for('service_admin.remove_virus_coat_organism_form_entry',
                                               name=subform.name) }}"
                                           hx-target="closest tr"
                                           hx-swap="outerHTML"
                                        >
                                            <span class="icon"><i class="fas fa-trash-alt"></i></span>
                                        </a>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        <tr>
                            <td style="border: none">
                                {% if fields.name == 'liquid_condition_field' %}
                                    <a class="button is-info is-outlined is-rounded"
                                       hx-post="{{ url_for('service_admin.add_virus_liquid_organism_form_entry') }}"
                                       hx-target="previous tr"
                                       hx-swap="afterend"
                                    >
                                        <span class="icon"><i class="fas fa-plus"></i></span>
                                        <span>เพิ่ม</span>
                                    </a>
                                {% elif fields.name == 'spray_condition_field' %}
                                    <a class="button is-info is-outlined is-rounded"
                                       hx-post="{{ url_for('service_admin.add_virus_spray_organism_form_entry') }}"
                                       hx-target="previous tr"
                                       hx-swap="afterend"
                                    >
                                        <span class="icon"><i class="fas fa-plus"></i></span>
                                        <span>เพิ่ม</span>
                                    </a>
                                {% else %}
                                    <a class="button is-info is-outlined is-rounded"
                                       hx-post="{{ url_for('service_admin.add_virus_coat_organism_form_entry') }}"
                                       hx-target="previous tr"
                                       hx-swap="afterend"
                                    >
                                        <span class="icon"><i class="fas fa-plus"></i></span>
                                        <span>เพิ่ม</span>
                                    </a>
                                {% endif %}
                            </td>
                        </tr>
                        </tbody>
                    </table>
                {% elif field.name.endswith('surface_type') %}
                    <div class="field ml-4" style="display: none" id="surface_type_field">
                        <label class="label">
                            {{ field.label }}
                            <span class="has-text-danger">*</span>
                        </label>
                        <div class="control">
                            {{ field() }}
                        </div>
                    </div>
                {% elif field.name.endswith('surface_type_other') %}
                    <div class="field ml-4">
                        <label class="label">
                            {{ field.label }}
                            <span class="has-text-danger">*</span>
                        </label>
                        <div class="control">
                            {{ field() }}
                        </div>
                    </div>
                {% else %}
                    <div class="field">
                        <label class="label">
                            {{ field.label }}
                            <span class="has-text-danger">*</span>
                        </label>
                        <div class="control">
                            {{ field() }}
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        {% endfor %}
        <button id="{{ fields.name }}" type="button" class="button is-danger is-rounded is-small remove-subform"
                hx-target=".subform-card"
                hx-swap="innerHTML"
        >
            ลบ
        </button>
    </div>
</div>
<script>
    function toggleTable(subform) {
        const table = subform.find('table');

        function validateInput() {
            table.find('tbody tr').each(function () {
                const textInputs = $(this).find('input[type="text"]');

                textInputs.each(function () {
                    const name = $(this).attr('name');
                    const isOptional = name.endsWith('ratio');

                    if (!isOptional) {
                        $(this)
                            .prop('required', true)
                            .attr('oninvalid', "this.setCustomValidity('กรุณากรอกข้อมูล')")
                            .attr('oninput', "this.setCustomValidity('')");
                    } else {
                        $(this).prop('required', false);
                        this.setCustomValidity('');
                    }
                })
            });
        }

        validateInput();
    }

    function addRequiredField(subform) {
        const testMethodInput = subform.find('input[name$="test_method"]');
        const injectTypeInput = subform.find('input[name$="inject_type"]');
        const productPreparationInput = subform.find('input[name$="product_preparation"]');

        injectTypeInput.prop('required', true)
            .attr('oninvalid', "this.setCustomValidity('กรุณาเลือกประเภทการฉีด')");

        injectTypeInput.on('change', function () {
            injectTypeInput.each(function () {
                this.setCustomValidity('');
            });
        });

        productPreparationInput.prop('required', true)
            .attr('oninvalid', "this.setCustomValidity('กรุณาเลือกการเตรียมผลิตภัณฑ์เพื่อการทดสอบ')");

        productPreparationInput.on('change', function () {
            productPreparationInput.each(function () {
                this.setCustomValidity('');
            });
        });

        function validateTestMethod() {
            const count = testMethodInput.filter(':checked').length;
            if (count == 0) {
                testMethodInput.prop('required', true);
                testMethodInput.each(function () {
                    this.setCustomValidity('กรุณาเลือกวิธีทดสอบอย่างน้อย 1 รายการ');
                });
            } else {
                testMethodInput.prop('required', false);
                testMethodInput.each(function () {
                    this.setCustomValidity('');
                });
            }
        }

        validateTestMethod();

        testMethodInput.on('change', validateTestMethod);
    }

    function toggleSurfaceTypeInput(subform) {
        const testMethod = subform.find('input[type="radio"][name$="test_method"]:checked').val();
        const surfaceTypeField = subform.find('#surface_type_field');
        const surfaceTypeInput = subform.find('input[name$="surface_type"]');
        const surfaceTypeOtherField = subform.find('input[name$="surface_type_other"]');

        if (testMethod && testMethod.includes('Modified ASTM E1053-20')) {
            surfaceTypeField.show()
            surfaceTypeInput.prop('required', true)
                .attr('oninvalid', "this.setCustomValidity('กรุณาเลือกชนิดพื้นผิว')");

            surfaceTypeInput.on('change', function () {
                surfaceTypeInput.each(function () {
                    this.setCustomValidity('');
                });
            });
        } else {
            surfaceTypeInput.each(function () {
                let name = $(this).attr('name');
                if (subform.find('input[name="' + name + '"][type="hidden"]').length === 0) {
                    subform.append('<input type="hidden" name="' + name + '" value="">');
                }
            });
            surfaceTypeField.hide()
            surfaceTypeInput.prop('required', false)
            surfaceTypeInput.prop('checked', false)
            surfaceTypeOtherField.val('');
        }
    }

    function showSurfaceTypeOtherInput(subform) {
        const surfaceTypeField = subform.find('input[type="radio"][name$="surface_type"]:checked').val();
        const surfaceTypeOtherInput = subform.find('input[name$="surface_type_other"]');
        const surfaceTypeOtherField = surfaceTypeOtherInput.closest('.field');

        if (surfaceTypeField && surfaceTypeField.includes('อื่น ๆ')) {
            surfaceTypeOtherField.show();
            surfaceTypeOtherInput.prop('required', true).attr('oninvalid', "this.setCustomValidity('กรุณากรอกชนิดพื้นผิว')")
                .attr('oninput', "this.setCustomValidity('')");
        } else {
            surfaceTypeOtherField.hide();
            surfaceTypeOtherInput.prop('required', false)
            surfaceTypeOtherInput.val('');
        }
    }

    $('.subform-card').each(function () {
        const subform = $(this);
        toggleTable(subform);
        addRequiredField(subform);
        toggleSurfaceTypeInput(subform);
        showSurfaceTypeOtherInput(subform);

        subform.find('input[type="radio"][name$="test_method"]').change(function () {
            toggleSurfaceTypeInput(subform);
            showSurfaceTypeOtherInput(subform);
        });

        subform.find('input[type="radio"][name$="surface_type"]').change(function () {
            showSurfaceTypeOtherInput(subform);
        });
    });
</script>
<div class="card subform-card mb-4" id="{{ fields.name }}">
    <header class="card-header">
        <p class="card-header-title">{{ fields.label }}</p>
    </header>
    <div class="card-content">
        {% for field in fields %}
            {% if field.type != 'HiddenField' and field.type != 'CSRFTokenField' %}
                {% if field.type == 'FieldList' %}
                    <table class="table is-fullwidth ">
                        <thead>
                        {% for subform in field %}
                            {% if loop.first %}
                                {% for _field in subform %}
                                    {% if _field.type != 'CSRFTokenField' %}
                                        <th style="border: none">{{ _field.label.text }}</th>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        {% endfor %}
                        </thead>
                        <tbody>
                        {% for subform in field %}
                            <tr>
                                {% for _field in subform %}
                                    {% if _field.type != 'CSRFTokenField' %}
                                        <td style="border: none">{{ _field() }}</td>
                                    {% endif %}
                                {% endfor %}
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <div class="field">
                        <label class="label">{{ field.label }}</label>
                        <div class="control">
                            {{ field() }}
                        </div>
                    </div>
                {% endif %}
            {% endif %}
        {% endfor %}
        <button id="{{ fields.name }}" type="button" class="button is-danger is-rounded is-small remove-subform" hx-target=".subform-card"
                hx-swap="innerHTML"
        >
            ลบ
        </button>
    </div>
</div>
<script>
    function toggleTable() {
        $('table tbody tr').each(function () {
            const row = $(this);
            const checkbox = row.find('input[type="checkbox"]');
            const textInputs = row.find('input[type="text"]');

            if (checkbox.is(':checked')) {
                textInputs.prop('disabled', false).attr('required', true);
            } else {
                textInputs.prop('disabled', true).val('').removeAttr('required');
            }
        });

        $('table tbody tr input[type="checkbox"]').on('change', function () {
            const row = $(this).closest('tr');
            const checked = $(this).is(':checked');

            row.find('input[type="text"]').each(function () {
                if (checked) {
                    $(this).prop('disabled', false).attr('required', true);
                } else {
                    $(this).prop('disabled', true).val('').removeAttr('required');
                }
            });
        });
    }

     function addRequiredField(subform) {
        const cleanTypeInput = subform.find('input[name$="clean_type"]');

        cleanTypeInput.prop('required', true);
    }

    function showClenTypeOtherInput(subform) {
        const cleanTypeField = subform.find('input[type="radio"][name$="clean_type"]:checked').val();
        const cleanTypeOtherInput = subform.find('input[name$="clean_type_other"]');
        const cleanTypeOtherField = cleanTypeOtherInput.closest('.field');

        if (cleanTypeField && cleanTypeField.includes('อื่นๆ โปรดระบุ')) {
            cleanTypeOtherField.show();
            cleanTypeOtherInput.prop('required', true);
        } else {
            cleanTypeOtherField.hide();
            cleanTypeOtherInput.val('');
        }
    }

    $('.subform-card').each(function () {
        const subform = $(this);
        toggleTable();
        addRequiredField(subform);
        showClenTypeOtherInput(subform);
        subform.find('input[type="radio"][name$="clean_type"]').change(function () {
            showClenTypeOtherInput(subform);
        });
    });
</script>
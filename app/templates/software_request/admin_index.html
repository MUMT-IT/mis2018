{% extends "base.html" %}
{% block title %}MUMT Internal Information System{% endblock %}
{% block head %}
    {{ super() }}
    <link href="https://fastly.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.print.css" media="print">
    <link rel="stylesheet" type="text/css" href="https://fastly.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
{% endblock %}
{% include "nav.html" %}
{% block page_content %}
    <section class="section">
        <div class="container">
            <h1 class="title">รายการขอรับบริการพัฒนา Software (สำหรับหน่วย IT)</h1>
            {% include 'messages.html' %}
            <hr>
            <h1 class="title is-size-4">Request</h1>
            <div class="tabs is-boxed">
                <ul>
                    <li {% if tab == 'pending' %}class="is-active"{% endif %}>
                        <a href="{{ url_for('software_request.admin_index', tab='pending') }}">
                            <span class="icon is-small"><i class="fas fa-hourglass-half"></i></span>
                            <span style="margin-right: .5em">รอดำเนินการ</span>
                            {% if pending_count %}
                                <span class="tag is-rounded is-danger">{{ pending_count }}</span>
                            {% endif %}
                        </a>
                    </li>
                    <li {% if tab == 'consider' %}class="is-active"{% endif %}>
                        <a href="{{ url_for('software_request.admin_index', tab='consider') }}">
                            <span class="icon is-small"><i class="fas fa-history"></i></span>
                            <span style="margin-right: .5em">อยู่ระหว่างพิจารณา</span>
                            {% if consider_count %}
                                <span class="tag is-rounded is-danger">{{ consider_count }}</span>
                            {% endif %}
                        </a>
                    </li>
                    <li {% if tab == 'approve' %}class="is-active"{% endif %}>
                        <a href="{{ url_for('software_request.admin_index', tab='approve') }}">
                            <span class="icon is-small"><i class="fas fa-pen-fancy"></i></span>
                            <span style="margin-right: .5em">อนุมัติ</span>
                            {% if approve_count %}
                                <span class="tag is-rounded is-danger">{{ approve_count }}</span>
                            {% endif %}
                        </a>
                    </li>
                    <li {% if tab == 'complete' %}class="is-active"{% endif %}>
                        <a href="{{ url_for('software_request.admin_index', tab='complete') }}">
                            <span class="icon is-small"><i class="fas fa-check"></i></span>
                            <span style="margin-right: .5em">เสร็จสิ้น</span>
                            {% if complete_count %}
                                <span class="tag is-rounded is-danger">{{ complete_count }}</span>
                            {% endif %}
                        </a>
                    </li>
                    <li {% if tab == 'disapprove' %}class="is-active"{% endif %}>
                        <a href="{{ url_for('software_request.admin_index', tab='disapprove') }}">
                            <span class="icon is-small"><i class="fas fa-times"></i></span>
                            <span style="margin-right: .5em">ไม่อนุมัติ</span>
                            {% if disapprove_count %}
                                <span class="tag is-rounded is-danger">{{ disapprove_count }}</span>
                            {% endif %}
                        </a>
                    </li>
                    <li {% if tab == 'cancel' %}class="is-active"{% endif %}>
                        <a href="{{ url_for('software_request.admin_index', tab='cancel') }}">
                            <span class="icon is-small"><i class="fas fa-ban"></i></span>
                            <span style="margin-right: .5em">ยกเลิก</span>
                            {% if cancel_count %}
                                <span class="tag is-rounded is-danger">{{ cancel_count }}</span>
                            {% endif %}
                        </a>
                    </li>
                    <li {% if tab == 'private' %}class="is-active"{% endif %}>
                        <a href="{{ url_for('software_request.admin_index', tab='private') }}">
                            <span class="icon is-small"><i class="fas fa-user"></i></span>
                            <span>ส่วนตัว</span>
                        </a>
                    </li>
                    <li {% if tab == 'all' %}class="is-active"{% endif %}>
                        <a href="{{ url_for('software_request.admin_index', tab='all') }}">
                            <span class="icon is-small"><i class="fas fa-list-ul"></i></span>
                            <span>ทั้งหมด</span>
                        </a>
                    </li>
                </ul>
            </div>
            <div class="columns">
                <div class="column">
                    <table id="request" class="table is-fullwidth">
                        <thead>
                        <tr>
                            <th>โครงการ/ระบบ</th>
                            <th>ประเภทคำขอ</th>
                            <th>รายละเอียด</th>
                            <th>ผู้ส่งคำขอ</th>
                            <th>สังกัด</th>
                            <th>วันที่ส่งคำขอ</th>
                            <th>สถานะ</th>
                            <th>Timelines</th>
                            <th>issues</th>
                            <th></th>
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            <hr>
            <h1 class="title is-size-4">Timeline</h1>
            <p>คลิกเพื่อข้ามไปวันที่ที่ต้องการตรวจสอบ</p>
                <div class="field">
                    <div class="control has-icons-left">
                        <input class="input" name="datePicker" id="datePicker">
                        <span class="icon is-small is-left">
                    <i class="far fa-calendar-alt"></i>
                </span>
                    </div>
                </div>
            <div class="columns">
                <div class="column">
                    <div id="timeline_calendar"></div>
                </div>
            </div>
        </div>
    </section>
{% endblock %}
{% block scripts %}
    {{ super() }}
    <script src="https://fastly.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.22.2/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/3.9.0/fullcalendar.min.js"></script>
    <script type="text/javascript" src="https://fastly.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script>
        window.document.addEventListener("closeTimeline", function () {
            htmx.removeClass(htmx.find('#timeline-modal'), "is-active")
        })
    </script>
    <script>
        $(document).ready(function () {
            $('#timeline').DataTable({
                order: [[2, 'asc']]
            })
        });
    </script>
    <script>
        $(function () {
            $('#datePicker').daterangepicker({
                singleDatePicker: true,
                startDate: moment()
            }, function(start, end, label) {
                $('#timeline_calendar').data('fullCalendar').gotoDate(start);
            }
            );
            $('#timeline_calendar').fullCalendar({
                header: {
                    left: 'title',
                },
                events: '/software_request/api/timelines/' + '{{ tab }}',
                eventLimit: true,
                lazyFetching: true,
                eventClick: function (calEvent, jsEvent, view) {
                    window.location = '/software_request/timelines/' + calEvent.id;
                }
            });
        });
    </script>
    <script>
        $(document).ready(function () {
            $.fn.dataTable.moment('lll');
            $('#request').DataTable({
                ajax: {
                    url: {{ url_for('software_request.admin_index', tab=tab, api='true')|tojson|safe}},
                },
                order: [[5, 'desc']],
                columns: [
                    {data: 'title'},
                    {data: 'type'},
                    {data: 'description'},
                    {data: 'created_by'},
                    {data: 'org'},
                    {
                        data: 'created_date',
                        render: function (data) {
                            if (data !== null) {
                                let d = moment(data)
                                return d.format('lll')
                            } else {
                                return ''
                            }
                        }
                    },
                    {
                        data: 'status',
                        render: function (data, type, row) {
                            var text = data == 'เสร็จสิ้น' ? 'ดำเนินการเสร็จสิ้น' : row.has_timeline ? 'กำลังพัฒนา' : 'ยังไม่ดำเนินการ';
                            var status_color = data == 'เสร็จสิ้น' ? 'is-success' : row.has_timeline ? 'is-warning' : 'is-danger';
                            var icon = data == 'เสร็จสิ้น' ? '<i class="fas fa-check-circle"></i>' : row.has_timeline ? '<i class="fas fa-hourglass-end"></i>' : '<i class="fas fa-times-circle"></i>';
                            if (data != null) {
                                return '<span class="tag ' + status_color + '">' +
                                    '<span class="icon">' +
                                    icon +
                                    '</span>' +
                                    '<span>' +
                                    text +
                                    '</span>' +
                                    '</span>';
                            } else {
                                return '<span class="tag is-danger">' +
                                    '<span class="icon">' +
                                    '<i class="fas fa-times-circle"></i>' +
                                    '</span>' +
                                    '<span>' +
                                    'ยังไม่ดำเนินการ' +
                                    '</span>' +
                                    '</span>'
                            }
                        }
                    },
                    {
                        data: 'num_timelines',
                        render: function (data) {
                            if (data > 0) {
                                return `<span class="tag is-rounded is-danger">${data}</span>`
                            } else {
                                return `<span class="tag is-rounded is-light">0</span>`
                            }
                        }
                    },
                    {
                        data: 'open_issues',
                        render: function (data) {
                            if (data > 0) {
                                return `<span class="tag is-rounded is-danger">${data}</span>`
                            } else {
                                return `<span class="tag is-rounded is-light">0</span>`
                            }
                        }
                    },
                    {
                        data: 'id',
                        render: function (data) {
                            var url = '/software_request/admin/request/edit/' + data + '?tab=' + '{{ tab }}';
                            return `<div class="field">
                                        <div class="control">
                                            <a href="${url}">
                                                <span class="icon">
                                                    <i class="fa-solid fa-eye"></i>
                                                </span>
                                            </a>
                                        </div>
                                    </div>`;
                        }
                    }
                ]
            });
        });
    </script>
{% endblock %}
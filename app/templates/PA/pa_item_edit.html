{% extends "base.html" %}
{% block title %}MUMT MIS: Performance Agreement {% endblock %}
{% include "PA/nav.html" %}
{% block head %}
    {{ super() }}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        .htmx-swapping {
            opacity: 0;
            transition: opacity 1s ease-out;
        }
        span { cursor: pointer; }
    </style>
    <style>
        #myBtn {
            display: none; /* Hidden by default */
            position: fixed; /* Fixed/sticky position */
            bottom: 20px; /* Place the button at the bottom of the page */
            right: 30px; /* Place the button 30px from the right */
            z-index: 99; /* Make sure it does not overlap */
            border: none; /* Remove borders */
            outline: none; /* Remove outline */
            background-color: red; /* Set a background color */
            color: white; /* Text color */
            cursor: pointer; /* Add a mouse pointer on hover */
            padding: 15px; /* Some padding */
            border-radius: 10px; /* Rounded corners */
            font-size: 18px; /* Increase font size */
        }

        #myBtn:hover {
            background-color: #555; /* Add a dark-grey background on hover */
        }
    </style>
{% endblock %}
{% block page_content %}
    <section class="section">
        <div>
            <nav class="breadcrumb" aria-label="breadcrumbs">
                <ul>
                    <li><a href="{{ url_for('pa.user_performance') }}">หน้าหลัก</a></li>
                    <li class="is-active"><a href="#" aria-current="page">แบบข้อตกลงและประเมินผลการปฏิบัติงาน</a></li>
                </ul>
            </nav>
            {% include 'messages.html' %}
            <div class="columns">
                <div class="column">
                    {% if task_id %}
                        <h1 class="title has-text-centered">แก้ไขภาระงาน</h1>
                        <h1 class="subtitle has-text-centered">รอบการประเมิน {{ pa_round }}</h1>
                    {% else %}
                        <h1 class="title has-text-centered">เพิ่มภาระงาน</h1>
                        <h1 class="subtitle has-text-centered">รอบการประเมิน {{ pa_round }}</h1>
                        <h1 class="subtitle has-text-centered">ประเภท
                            {% for e in pa_round.employments %}
                            {{ e.title }}
                            {% endfor %}
                        </h1>
                    {% endif %}
                    {% if current_user.processes %}
                        <div class="card">
                            <div class="card-header">
                                <p class="card-header-title">กระบวนการทำงานที่รับผิดชอบ</p>
                            </div>
                            <div class="card-content">
                                <table class="table is-fullwidth">
                                    <thead>
                                    <th>ชื่อกระบวนการ</th>
                                    <th>กระบวนการหลัก</th>
                                    <th>กระบวนการย่อย</th>
                                    </thead>
                                    {% for proc in current_user.processes %}
                                        <tr>
                                            <td>
                                                {{ proc.name }}
                                            </td>
                                            <td>
                                                {% if not proc.parent %}
                                                    <span class="icon">
                                                <i class="fas fa-check has-text-success"></i>
                                            </span>
                                                {% endif %}
                                                <span>
                                            {{ proc.parent.name or '' }}
                                        </span>
                                            </td>
                                            <td>
                                                {% if proc.parent %}
                                                    <span class="icon">
                                                    <i class="fas fa-check has-text-success"></i>
                                                </span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </table>
                            </div>
                        </div>
                    {% endif %}
                    <form method="post">
                        {{ form.hidden_tag() }}
                        <br>
                        <div class="card">
                            <div class="card-header">
                                <p class="card-header-title">ส่วนที่ 2 ข้อตกลงการปฏิบัติงาน(Performance Agreement:
                                    PA)</p>
                            </div>
                            <div class="card-content">
                                <p class="subtitle is-6">
                                    1.ให้ผู้บังคับบัญชาชั้นต้นและผู้รับการประเมินตกลงร่วมกันเกี่ยวกับภาระงาน ค่าน้ำหนัก
                                    ตัวชี้วัด เป้าหมาย เกณฑ์การประเมิน ให้สอดคล้องตามลักษณะงาน ตำแหน่งงานและความรู้
                                    ความสามารถ โดยให้คำนึงถึงแผนยุทธศาสตร์ แผนกลยุทย์ และหรือเป้าหมายของมหาวิทยาลัย
                                    ส่วนงานและหรือหน่วยงาน</p>
                                <p class="subtitle is-6">2.ให้ผู้รับการประเมินกรอกภาระงาน ค่าน้ำหนัก ตัวชี้วัด เป้าหมาย
                                    เกณฑ์การประเมิน เป็นลายลักษณ์อักษร
                                    พร้อมให้ผู้รับการประเมินและผู้บังคับบัญชาชั้นต้นลงลายมือชื่อไว้ด้วย</p>
                                <p class="subtitle is-6">2.1 ภาระงานและตัวชี้วัดเป้าหมายความสำเร็จของภาระงาน</p>
                                <a id="pa_table"></a>
                                <table class="table is-fullwidth is-bordered">
                                    <thead>
                                    <th>หมวด</th>
                                    <th>ภาระงาน
                                        <button hx-get="{{ url_for('pa.add_pa_item_form', round_id=pa_round.id) }}"
                                                hx-target="#pa-edit-form-container"
                                                hx-swap="innerHTML"
                                                class="button is-small is-outlined is-success">
                                            <span class="icon"><i class="fa-solid fa-plus"></i></span>
                                            <span>เพิ่มรายการ</span>
                                        </button>
                                    </th>
                                    </thead>
                                    <tbody>
                                    {% for cat in categories %}
                                        <tr>
                                            <td style="width: 10%">
                                                {{ cat }}
                                            </td>
                                            <td>
                                                {% if cat.pa_items.filter_by(pa_id=pa.id).all() %}
                                                    <table class="table is-fullwidth">
                                                        <thead>
                                                        {#<th>ลำดับ</th>#}
                                                        <th>งานที่รับผิดชอบ</th>
                                                        <th>%</th>
                                                        <th>ผลการดำเนินการ</th>
                                                        <th colspan="2">ตัวชี้วัด</th>
                                                        </thead>
                                                        <tbody>
                                                        {% for pa_item in cat.pa_items.filter_by(pa_id=pa.id)|sort(attribute='id') %}
                                                            <tr>
                                                                <td style="width: 20%">{{ pa_item.task|safe }}
                                                                    {% if pa.editable or pa.can_enter_result %}
                                                                        <span hx-get="{{ url_for('pa.add_pa_item_form', round_id=pa_round.id, item_id=pa_item.id, pa_id=pa.id) }}"
                                                                                hx-target="#pa-edit-form-container"
                                                                                hx-swap="innerHTML" class="tag is-small">
                                                                            <span class="icon is-small">
                                                                                <i class="fa-solid fa-pencil {% if pa_item_id == pa_item.id %} has-text-success {% endif %}"></i>
                                                                            </span>
                                                                            <span>แก้ไข</span>
                                                                        </span>
                                                                    {% endif %}
                                                                </td>
                                                                <td style="width: 10%">{{ pa_item.percentage }}</td>
                                                                <td style="width: 30%;">{{ pa_item.report|safe }}</td>
                                                                <td style="width: 30%">
                                                                    <ul>
                                                                        {% for kpi_item in pa_item.kpi_items %}
                                                                            <li><span class="icon"><i
                                                                                    class="fa-solid fa-star has-text-warning"></i></span>
                                                                                <small>{{ kpi_item }}</small><li>(เก็บข้อมูลจาก: {{ kpi_item.kpi.source }})</li>
                                                                            </li>
                                                                        {% endfor %}
                                                                    </ul>
                                                                    {% if pa.editable or pa.can_enter_result %}
                                                                        <span hx-get="{{ url_for('pa.add_pa_item_kpi_form', round_id=pa_round.id, item_id=pa_item.id, pa_id=pa.id) }}"
                                                                                hx-target="#pa-edit-form-container"
                                                                                hx-swap="innerHTML"
                                                                                class="tag is-small">
                                                                            <span class="icon is-small">
                                                                                <i class="fa-solid fa-pencil {% if pa_item_id == pa_item.id %} has-text-success {% endif %}"></i>
                                                                            </span>
                                                                            <span>เพิ่ม/แก้ไข</span>
                                                                        </span>
                                                                    {% endif %}
                                                                </td>
                                                                <td colspan="2">
                                                                    <div class="buttons">
                                                                        {% if pa.editable %}
                                                                            <a class="button"
                                                                               hx-swap="outerHTML swap:1s"
                                                                               hx-target="closest tr"
                                                                               hx-confirm="คุณต้องการลบรายการนี้หรือไม่"
                                                                               hx-delete="{{ url_for('pa.delete_pa_item', pa_id=pa.id, pa_item_id=pa_item.id) }}">
                                                                            <span class="icon is-small">
                                                                                <i class="fa-solid fa-trash-can has-text-danger"></i>
                                                                            </span>
                                                                            </a>
                                                                        {% endif %}
                                                                    </div>
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                        </tbody>
                                                    </table>
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    <tr>
                                        <td>รวมสัดส่วนภาระงาน</td>
                                        <td><strong>{{ pa.total_percentage }} %</strong></td>
                                    </tr>
                                    </tbody>
                                </table>
                                <a id="edit_form"></a>
                                <div id="pa-edit-form-container"></div>
                                <p class="title is-size-4 has-text-centered">
                                    <button hx-get="{{ url_for('pa.add_pa_item_form', round_id=pa_round.id) }}"
                                            hx-target="#pa-edit-form-container"
                                            hx-swap="innerHTML"
                                            class="button is-outlined is-success">
                                        <span class="icon"><i class="fa-solid fa-plus"></i></span>
                                        <span>
                                            เพิ่มข้อมูลภาระงาน
                                        </span>
                                    </button>
                                </p>
                                {% if pa.kpis %}
                                    <h1 class="title is-size-4">รายการตัวชี้วัด</h1>
                                    <table class="table is-fullwidth is-striped">
                                        {% for item_form in form.kpi_items_ %}
                                            <tr>
                                                <td style="width: 40%">
                                                    <div class="field">
                                                        <label class="label">
                                                            {{ loop.index }}) {{ item_form.label }}
                                                        </label>
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="buttons">
                                                        {% if pa.editable %}
                                                            <a href="{{ url_for('pa.edit_kpi', pa_id=pa.id, kpi_id=item_form.obj_id) }}"
                                                               class="button">
                                                                <span class="icon is-small">
                                                                    <i class="fa-solid fa-pencil"></i>
                                                                </span>
                                                            </a>
                                                            <a class="button"
                                                               hx-swap="none"
                                                               hx-confirm="คุณต้องการลบรายการนี้หรือไม่"
                                                               hx-delete="{{ url_for('pa.delete_kpi', kpi_id=item_form.obj_id, pa_id=pa.id) }}">
                                                                <span class="icon is-small">
                                                                    <i class="fa-solid fa-trash-can has-text-danger"></i>
                                                                </span>
                                                            </a>
                                                        {% endif %}
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </table>
                                {% else %}
                                    <p class="notification is-warning is-light">
                                        <button class="delete"></button>
                                        ท่านยังไม่มีตัวชี้วัดสำหรับประเมินภาระงาน กรุณาเพิ่มตัวชี้วัด
                                    </p>
                                {% endif %}
                                <div class="field">
                                    <label class="label">
                                        {% if not pa.editable %}
                                            <span class="icon"><i class="fa-solid fa-lock"></i></span>
                                        {% endif %}
                                        {{ form.report.label }}
                                    </label>
                                    <div class="control">
                                        {% if (pa.approved_at and not pa.submitted) and pa_item_id %}
                                            {{ form.report(class="textarea is-success" if pa_item_id else "textarea", disabled=False) }}
                                        {% else %}
                                            {{ form.report(class="textarea is-success" if pa_item_id else "textarea", disabled=True) }}
                                        {% endif %}
                                    </div>
                                </div>
                                {% if not pa.updated_at %}
                                <div class="field is-grouped is-grouped-centered">
                                    <a class="button is-warning"
                                    href="{{ url_for('pa.copy_pa', pa_id=pa.id) }}">
                                            <span class="icon">
                                                <i class="fas fa-copy"></i>
                                            </span>
                                            <span>คัดลอกภาระงานจาก PA รอบเก่า **กดก่อนเพิ่มภาระงานใหม่</span>
                                        </a>
                                </div>
                                {% endif %}
                                {% if not pa.submitted %}
                                    <div class="field is-grouped is-grouped-centered">
                                        <div class="control">
                                            <button type="submit" class="button is-success">
                                            <span class="icon">
                                                <i class="fas fa-save"></i>
                                            </span>
                                                <span>บันทึก</span>
                                            </button>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </form>
                    <div class="buttons is-centered">
                        {% if not pa.approved_at %}
                            <a class="button is-info"
                               onclick="return confirm('กรุณาบันทึกการแก้ไขก่อนคลิก OK เพื่อดำเนินการเพิ่มตัวชี้วัด หากไม่มีการแก้ไขเพิ่มเติมคลิก OK เพื่อดำเนินการต่อ')"
                               href="{{ url_for('pa.add_kpi', pa_id=pa.id, round_id=pa_round.id) }}">
                                                <span class="icon">
                                                    <i class="fa-solid fa-location-crosshairs"></i>
                                                </span>
                                <span>เพิ่มตัวชี้วัด</span>
                            </a>
                        {% endif %}
                        <a href="{{ url_for('pa.create_request', pa_id=pa.id) }}"
                           class="button is-info is-outlined">
                            <span class="icon">
                                <i class="fa-sharp fa-solid fa-paper-plane"></i>
                            </span>
                            <span>ส่งคำขอ</span>
                        </a>
                        {% if pa.approved_at %}
                            <a onclick="return confirm('เมื่อประเมินตนเองแล้ว จะไม่สามารถแก้ไขตัวชี้วัดและภาระงานได้อีก หากแน่ใจแล้วคลิก OK เพื่อดำเนินการประเมินตนเอง')"
                               href="{{ url_for('pa.create_scoresheet_for_self_evaluation', pa_id=pa.id) }}"
                               class="button is-warning is-outlined">
                            <span class="icon">
                                <i class="fa-solid fa-star"></i>
                            </span>
                                <span>ประเมินตนเอง</span>
                            </a>
                        {% endif %}
                    </div>
                    {% if not pa.editable %}
                        <div class="has-text-centered">
                            <p style="color:red">หากต้องการปรับแก้ไขภาระงาน/ตัวชี้วัด ให้ส่งคำขอแก้ไข</p>
                        </div>
                    {% endif %}
                </div>
            </div>
            <h1 class="title">สถานะแบบประเมิน</h1>
            <div class="columns has-text-centered">
                <div class="column">
                    <table class="table">
                        <tr>
                            <td>แก้ไขล่าสุด</td>
                            <td>
                                {% if pa.updated_at %}
                                    <span class="tag is-rounded">
                                        <span class="icon">
                                            <i class="fa-solid fa-clock-rotate-left"></i>
                                        </span>
                                        <span>
                                            {{ pa.updated_at|localdatetime }}
                                        </span>
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td>รับรอง</td>
                            <td>
                                {% if pa.approved_at %}
                                    <span class="tag is-success is-rounded">
                                        <span class="icon">
                                            <i class="fas fa-check-circle"></i>
                                        </span>
                                        <span>{{ pa.approved_at|localdatetime }}</span>
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td>ส่งขอรับการประเมิน</td>
                            <td>
                                {% if pa.submitted_at %}
                                    <span class="tag is-info is-rounded">
                                        <span class="icon">
                                            <i class="fas fa-check-circle"></i>
                                        </span>
                                        <span>{{ pa.submitted_at|localdatetime }}</span>
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td>ส่งผลคะแนนให้ทาง HR</td>
                            <td>
                                {% if pa.evaluated_at %}
                                    <span class="tag is-danger is-rounded">
                                        <span class="icon">
                                            <i class="fas fa-check-circle"></i>
                                        </span>
                                        <span>{{ pa.evaluated_at|localdatetime }}</span>
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td>แจ้งผลให้ผู้รับการประเมิน</td>
                            <td>
                                {% if pa.inform_score_at %}
                                    <span class="tag is-info is-light is-rounded">
                                        <span class="icon">
                                            <i class="fas fa-check-circle"></i>
                                        </span>
                                        <span>{{ pa.inform_score_at|localdatetime }}</span>
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td>รับทราบผลการประเมิน</td>
                            <td>
                                {% if pa.accept_score_at %}
                                    <span class="tag is-info is-light is-rounded">
                                        <span class="icon">
                                            <i class="fas fa-check-circle"></i>
                                        </span>
                                        <span>{{ pa.accept_score_at|localdatetime }}</span>
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                    </table>
                </div>
            </div>
            <div class="columns">
                <div class="column">
                    <h1 class="title">สถานะการประเมินภาระงาน</h1>
                    <table class="table is-fullwidth">
                        <thead>
                        <th>สร้างเมื่อ</th>
                        <th>เพื่อ</th>
                        <th>รายละเอียด</th>
                        <th>สถานะ</th>
                        <th>ส่งเมื่อ</th>
                        <th>ตอบกลับเมื่อ</th>
                        <th>comment</th>
                        <th>หัวหน้าส่วนงาน</th>
                        <th>ยกเลิก</th>
                        </thead>
                        <tbody>
                        {% for req in pa.requests|sort(attribute='created_at') %}
                            <tr>
                                <td>{{ req.created_at|localdatetime }}</td>
                                <td>{{ req.for_ }}</td>
                                <td>{{ req.detail }}</td>
                                {% if req.status %}
                                    <td>
                                        {% if req.status == 'อนุมัติ' %}
                                            <span class="tag is-rounded is-success">
                                                <span class="icon">
                                                    <i class="far fa-check-circle"></i>
                                                </span>
                                                <span>{{ req.status }}</span>
                                            </span>
                                        {% else %}
                                            <span class="tag is-rounded is-danger">
                                                <span class="icon">
                                                    <i class="far fa-times-circle"></i>
                                                </span>
                                                <span>{{ req.status }}</span>
                                            </span>
                                        {% endif %}
                                    </td>
                                {% else %}
                                    <td>
                                    <span class="tag is-rounded is-warning">
                                        <span class="icon">
                                            <i class="fas fa-hourglass-half"></i>
                                        </span>
                                        <span>รอพิจารณา</span>
                                    </span>
                                    </td>
                                {% endif %}
                                <td>{{ req.submitted_at|localdatetime }}</td>
                                <td>{{ req.responded_at|localdatetime or '' }}</td>
                                <td>{{ req.supervisor_comment }}</td>
                                <td>{{ req.supervisor.fullname }}</td>
                                <td>
                                    {% if not req.responded_at %}
                                        <a class="button"
                                           hx-headers='{"X-CSRF-Token": {{ csrf_token()|tojson|safe }} }'
                                           hx-swap="none"
                                           hx-confirm="คุณต้องการยกเลิกรายการนี้หรือไม่"
                                           hx-target="closest tr"
                                           hx-delete="{{ url_for('pa.delete_request', request_id=req.id) }}">
                                            <span class="icon is-small">
                                                <i class="fa-solid fa-trash-can has-text-danger"></i>
                                            </span>
                                            <span class="has-text-danger">ยกเลิก</span>
                                        </a>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                    <button onclick="topFunction()" id="myBtn" title="Go to top">
                        <span class="icon"><i class="fas fa-arrow-up"></i></span><span>กลับขึ้นบน</span>
                    </button>
                </div>
            </div>
            {% if not pa.accept_score_at %}
                {% if pa.inform_score_at %}
                    <div class="buttons is-centered">
                        <a href="{{ url_for('pa.accept_overall_score', pa_id=pa.id) }}"
                           class="button is-info is-outlined is-large">
                        <span class="icon">
                            <i class="fa-sharp fa-solid fa-circle-check"></i>
                        </span>
                            <span>รับทราบผลการประเมิน</span>
                        </a>
                    </div>
                {% endif %}
            {% else %}
                <div class="buttons is-centered">
                    <a href="{{ url_for('pa.accept_overall_score', pa_id=pa.id) }}"
                       class="button is-info is-outlined">
                        <span>ผลการประเมิน</span>
                    </a>
                </div>
            {% endif %}
        </div>
        <div class="columns">
            <div class="column has-text-centered">
                <a href="{{ url_for('pa.user_performance') }}"
                   class="button is-light">
                    <span class="icon">
                        <i class="fa-solid fa-chevron-left"></i>
                    </span>
                    <span>กลับ</span>
                </a>
            </div>
        </div>
    </section>
{% endblock %}
{% block scripts %}
    {{ super() }}
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function () {
            $('#percent-warning').hide()
            {% if not pa_item_id %}
                $('#percentage').on('keyup', function () {
                    if ($(this).val() > 100 - parseFloat({{ pa.total_percentage|tojson|safe }})) {
                        $(this).addClass('is-danger')
                        $('#percent-warning').show()
                    } else {
                        $(this).removeClass('is-danger')
                        $('#percent-warning').hide()
                    }
                })
            {% else %}
                $('#percentage').on('keyup', function () {
                    if ($(this).val() > 100 + parseFloat({{ form.percentage.data|tojson|safe }}) - parseFloat({{ pa.total_percentage|tojson|safe }})) {
                        $(this).addClass('is-danger')
                        $('#percent-warning').show()
                    } else {
                        $(this).removeClass('is-danger')
                        $('#percent-warning').hide()
                    }
                })
            {% endif %}
            $('#zero-warning').hide()
            $('#percentage').on('keyup', function () {
                if ($(this).val() == 0) {
                    $(this).addClass('is-danger')
                    $('#zero-warning').show()
                } else {
                    $(this).removeClass('is-danger')
                    $('#zero-warning').hide()
                }
            })
        })
    </script>
    <script>
        let mybutton = document.getElementById("myBtn");

        // When the user scrolls down 20px from the top of the document, show the button
        window.onscroll = function () {
            scrollFunction()
        };

        function scrollFunction() {
            if (document.body.scrollTop > 20 || document.documentElement.scrollTop > 20) {
                mybutton.style.display = "block";
            } else {
                mybutton.style.display = "none";
            }
        }

        // When the user clicks on the button, scroll to the top of the document
        function topFunction() {
            document.body.scrollTop = 0; // For Safari
            document.documentElement.scrollTop = 0; // For Chrome, Firefox, IE and Opera
        }
    </script>
{% endblock %}
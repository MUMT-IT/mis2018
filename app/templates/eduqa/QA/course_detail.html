{% extends "base.html" %}
{% block title %}MUMT MIS: Quality Assurance for Education {% endblock %}
{% block head %}
{{ super() }}
    <link href="https://fastly.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
{% endblock %}
{% include "eduqa/QA/nav.html" %}
{% block page_content %}
<section class="section">
    <div class="container" id="app">
        <div class="columns">
            <div class="column has-text-centered">
                {% include 'messages.html' %}
            </div>
        </div>
        <div class="columns">
          <div class="column">
            <nav class="breadcrumb has-succeeds-separator" aria-label="breadcrumbs">
              <ul>
                <li><a href="{{ url_for('eduqa.show_revisions', curriculum_id=course.revision.curriculum.id) }}">หลักสูตร</a></li>
                <li><a href="{{ url_for('eduqa.show_revision_detail', revision_id=course.revision_id) }}" aria-current="page">รายวิชา</a></li>
                <li class="is-active"><a href="#" aria-current="page">รายละเอียด</a></li>
              </ul>
            </nav>
          </div>
        </div>
        <div class="columns">
            <div class="column">
                <h1 class="title has-text-centered">{{ course.th_name }}</h1>
                <h1 class="subtitle has-text-centered">{{ course.en_name }}</h1>
                <div id="course-import-modal"></div>
                <div class="buttons is-centered has-addons">
                    <a class="button is-dark is-outlined"
                       href="{{ url_for('eduqa.copy_course', course_id=course.id) }}">
                        <span class="icon">
                            <i class="far fa-copy"></i>
                        </span>
                        <span>คัดลอกรายวิชา</span>
                    </a>
                    <!--
                    <a class="button is-dark is-outlined"
                       hx-target="#course-import-modal"
                       hx-swap="innerHTML"
                       hx-get="{{ url_for('eduqa.import_course_data', course_id=course.id) }}">
                        <span class="icon">
                            <i class="fa-solid fa-file-import"></i>
                        </span>
                        <span>นำเข้าข้อมูลรายวิชาจากภาคการศึกษาอื่น</span>
                    </a>
                    -->
                    <a href="{{ url_for('staff.teaching_calendar') }}"
                       class="button is-dark is-outlined">
                      <span class="icon">
                        <i class="fas fa-calendar-alt"></i>
                      </span>
                      <span>ตารางสอน</span>
                    </a>
                </div>
            </div>
        </div>
        <div class="columns">
        </div>
        <div class="columns">
            <div class="column is-3">
                <aside class="menu">
                    <p class="menu-label">
                        Menu
                    </p>
                    <ul class="menu-list">
                        <li><a href="#section-1">หมวด 1 ข้อมูลทั่วไป</a></li>
                        <li><a href="#section-2">หมวด 2 เป้าหมายและคำอธิบายรายวิชา</a></li>
                        <li><a href="#section-3">หมวด 3 แผนการดำเนินการและการประเมินผลที่สอดคล้องกับผลลัพธ์การเรียนรู้</a></li>
                        <li><a href="#section-4">หมวด 4 แผนการสอน</a></li>
                        <li><a href="#section-5">หมวด 5 ทรัพยากรประกอบการเรียนการสอน</a></li>
                        <li><a href="#section-6">หมวด 6 การประเมินและการปรับปรุงการดำเนินการ</a></li>
                    </ul>
                    <p class="menu-label">
                        Utilities
                    </p>
                    <ul class="menu-list">
                        <li><a href="{{ url_for('eduqa.upload_grades', course_id=course.id) }}">รายงานผลการเรียน</a></li>
                        <li><a href="{{ url_for('eduqa.report_course_detail', course_id=course.id) }}">รายงานผลการดำเนินงานรายวิชา (มม.5)</a></li>
                        {% if course.has_admin(current_user.instructor) %}
                        <li><a href="{{ url_for('eduqa.export_grade_pdf', course_id=course.id) }}">พิมพ์รายงานผลการเรียน<span class="tag is-success is-rounded">new</span></a></li>
                        {% endif %}
                        <li><a href="{{ url_for('eduqa.instructor_evaluation', course_id=course.id) }}">แบบฟอร์มประเมินอาจารย์</a></li>
                    </ul>
                </aside>

            </div>
            <div class="column">
                <label class="label">ลิงค์ประมวลรายวิชาสำหรับนักศึกษาและบุคคลภายนอก</label>
                <div class="field has-addons">
                    <div class="control is-expanded">
                        <input id="evalLink"
                               class="input"
                               readonly
                               value="{{ url_for('eduqa.instructor_evaluation', course_id=course.id, _external=True) }}"/>
                    </div>
                    <div class="control">
                        <a class="button is-info" href="{{ url_for('eduqa.show_course_detail_public', course_id=course.id, _external=True) }}"
                        target="_blank">
                            <span class="icon">
                                <i class="fa-solid fa-arrow-up-right-from-square"></i>
                            </span>
                            <span>Open</span>
                        </a>
                    </div>
                </div>
                <h5 class="title is-size-4" id="section-1">หมวดที่ 1 ข้อมูลทั่วไป</h5>
                <table class="table is-striped is-bordered is-fullwidth">
                    <tr>
                        <td>
                            <label class="label">รหัส</label>
                        </td>
                        <td>
                            {{ course.th_code }}
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label class="label">Code</label>
                        </td>
                        <td>
                            {{ course.en_code }}
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label class="label">ชื่อ</label>
                        </td>
                        <td>
                            {{ course.th_name }}
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label class="label">Title</label>
                        </td>
                        <td>
                            {{ course.en_name }}
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label class="label">ระดับชั้น</label>
                        </td>
                        <td>
                            {{ course.student_year }}
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label class="label">หน่วยกิต</label>
                        </td>
                        <td>
                            {{ course.credits }} หน่วย (บรรยาย {{ course.lecture_credit }}, ปฏิบัติ {{ course.lab_credit }})
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label class="label">ภาคการศึกษา</label>
                        </td>
                        <td>
                            <span class="tag is-rounded is-medium">
                                {{ course.semester }} / {{ course.academic_year }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label class="label">จำนวนนักศึกษาที่ลงทะเบียน</label>
                        </td>
                        <td>
                            {{ course.students|length }} คน
                            <a class="button is-info is-small is-rounded"
                                    hx-target="#student-list"
                                    hx-get="{{ url_for('eduqa.show_students', course_id=course.id) }}"
                                    hx-swap-oob="true"
                                    id="hide-btn">
                                <span class="icon">
                                    <i class="fas fa-chevron-down"></i>
                                </span>
                                <span>show</span>
                            </a>
                            <div id="student-list"></div>
                        </td>
                    </tr>
                    <tr>
                      <td>
                        <label class="label">เพิ่มรายวิชาโดย</label>
                      </td>
                      <td>
                        {{ course.creator.fullname }}
                      </td>
                    </tr>
                </table>
                <div id="course-info-form-placeholder"></div>
                <div class="buttons is-centered">
                    <a class="button is-rounded is-outlined is-info"
                       hx-get="{{ url_for('eduqa.edit_course', course_id=course.id, refresh='true') }}"
                       hx-target="#course-info-form-placeholder"
                       hx-swap="innerHTML"
                    >
                        <span class="icon">
                            <i class="fas fa-pencil-alt"></i>
                        </span>
                        <span>แก้ไขข้อมูลทั่วไป</span>
                    </a>
                    {% if current_user == course.creator or course.has_admin(current_user.instructor) %}
                        <a class="button is-danger is-rounded" @click="warn">
                        <span class="icon">
                            <i class="far fa-trash-alt"></i>
                        </span>
                            <span>ลบรายวิชา</span>
                        </a>
                    {% endif %}
                </div>
                <h5 class="title is-size-4" id="section-2">หมวดที่ 2 เป้าหมายและคำอธิบายรายวิชา</h5>
                <table class="table is-striped is-bordered is-fullwidth">
                    <tr>
                        <td>
                            <label class="label">เป้าหมายรายวิชา</label>
                        </td>
                        <td>
                            {{ course.goal }}
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label class="label">คำอธิบายรายวิชา</label>
                        </td>
                        <td>
                            {{ course.th_desc }}
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <label class="label">Description</label>
                        </td>
                        <td>
                            {{ course.en_desc }}
                        </td>
                    </tr>
                </table>
                <a id="section-3"></a>
                <h5 class="title is-size-4" id="section-3">หมวดที่ 3 แผนการดำเนินการและการประเมินผลที่สอดคล้องกับผลลัพธ์การเรียนรู้</h5>
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="card-header-title">
                            <h5 class="title is-size-5">วัตถุประสงค์รายวิชา</h5>
                        </div>
                    </div>
                    <div class="card-content">
                        {{ course.objective }}
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="card-header-title">
                            <h5 class="title is-size-5">ความสอดคล้องกับรายวิชาและหลักสูตร</h5>
                        </div>
                    </div>
                    <div class="card-content">
                        <table class="table">
                            <thead>
                            <th>PLO</th>
                            <th>Sub PLO</th>
                            <th></th>
                            </thead>
                            <tbody>
                            {% for plo in course.revision.plos %}
                                {% if plo.parent_id == None %}
                                <tr>
                                <td>
                                    {{ plo }}
                                    {% for clo in plo.clos.filter_by(course_id=course.id) %}
                                        <span class="tag is-link is-rounded is-small">CLO{{ clo.number }}</span>
                                    {% endfor %}
                                </td>
                                <td>
                                    <ul>
                                        {% for sub_plo in plo.sub_plos %}
                                        <li>
                                            {{ sub_plo }}
                                            {% for clo in sub_plo.clos.filter_by(course_id=course.id) %}
                                                <span class="tag is-link is-rounded is-small">CLO{{ clo.number }}</span>
                                            {% endfor %}
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </td>
                                </tr>
                                {% endif %}
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="card-header-title">
                            <h5 class="title is-size-5">ผลลัพธ์การเรียนรู้ของรายวิชาและการประเมินผล (Course Learning Outcomes and Assessment)</h5>
                        </div>
                    </div>
                    <div class="card-content">
                        <h1 class="title is-size-5">
                            การประเมินเพื่อพัฒนาการเรียนรู้ (Formative Assessment)
                        </h1>
                        <div id="formative-assessment-form"></div>
                        <table class="table is-fullwidth is-bordered" id="formative-assessment-table">
                            <thead>
                            <th>ลำดับ</th>
                            <th>ระยะเวลา</th>
                            <th>รายละเอียด</th>
                            <th>เครื่องมือ</th>
                            <th>การป้อนกลับให้ผู้เรียน</th>
                            <th>
                                <button class="button is-small is-primary is-rounded"
                                        hx-target="#formative-assessment-form"
                                        hx-get="{{ url_for('eduqa.edit_formative_assessment', course_id=course.id) }}">
                                    <span class="icon">
                                        <i class="fa-solid fa-plus"></i>
                                    </span>
                                    <span>เพิ่ม</span>
                                </button>
                            </th>
                            </thead>
                            <tbody>
                                {% for a in course.formative_assessments %}
                                    <tr id="formative-assessment-id-{{ a.id }}">
                                        <td>{{ loop.index }}</td>
                                        <td>{{ a.start|localdatetime }} - {{ a.end|localdatetime }}</td>
                                        <td>
                                            {{ a.desc }}
                                        </td>
                                        <td>{{ a.assessment_tools }}</td>
                                        <td>{{ a.feedback }}</td>
                                        <td>
                                            <a hx-target="#formative-assessment-form"
                                               hx-swap="innerHTML"
                                               hx-get="{{ url_for('eduqa.edit_formative_assessment', course_id=course.id, assessment_id=a.id) }}">
                                               <span class="icon">
                                                   <i class="fas fa-pencil-alt has-text-primary"></i>
                                               </span>
                                            </a>
                                            <a hx-delete="{{ url_for('eduqa.edit_formative_assessment', course_id=course.id, assessment_id=a.id) }}"
                                               hx-confirm="Are you sure?"
                                            >
                                               <span class="icon">
                                                   <i class="far fa-trash-alt has-text-danger"></i>
                                               </span>
                                            </a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <h1 class="title is-size-5">
                            การประเมินเพื่อตัดสินผลการเรียนรู้ (Summative Assessment)
                        </h1>
                        <div id="clo-plo-form"></div>
                        <table class="table is-bordered is-fullwidth">
                            <thead>
                            <th>ลำดับ</th>
                            <th>
                                ผลลัพธ์การเรียนรู้และแผนการดำเนินการ
                                <p class="help is-info">ประกอบด้วย action verb + learning content + criteria/standard</p>
                            </th>
                            <th>PLOs</th>
                            <th>สัดส่วนคะแนน </th>
                            <th>
                                <button class="button is-small is-primary is-rounded"
                                        hx-target="#clo-form"
                                        hx-get="{{ url_for('eduqa.edit_clo', course_id=course.id) }}">
                            <span class="icon">
                                <i class="fa-solid fa-plus"></i>
                            </span>
                                    <span>เพิ่ม</span>
                                </button>
                            </th>
                            </thead>
                            <tbody id="clo-table">
                            {% for clo in course.outcomes|sort(attribute='number') %}
                                <tr id="clo-id-{{ clo.id }}">
                                    <td>CLO{{ clo.number }}
                                        <p>
                                            {% for plo in clo.plos %}
                                                <span class="tag is-link is-rounded is-small">PLO{{ plo.number }}</span>
                                            {% endfor %}
                                        </p>
                                    </td>
                                    <td>
                                        <p>
                                        <h1 class="title is-size-4">
                                            {{ clo.detail }}
                                        </h1>
                                        </p>
                                        <table class="table is-narrowed is-fullwidth" id="clo-table-{{ clo.id }}">
                                            <thead>
                                            <th>กิจกรรมการเรียนรู้</th>
                                            <th>การวัดผลลัพธ์</th>
                                            <th>น้ำหนัก</th>
                                            <th>
                                                <a class="button is-small is-rounded is-primary"
                                                   hx-swap="innerHTML"
                                                   hx-target="#learning-activity-form"
                                                   hx-get="{{ url_for('eduqa.edit_learning_activity', clo_id=clo.id, course_id=course.id) }}">
                                        <span class="icon">
                                           <i class="fa-solid fa-plus"></i>
                                        </span>
                                                    <span>เพิ่ม</span>
                                                </a>
                                            </th>
                                            </thead>
                                            <tbody>
                                            {% for pair in clo.learning_activity_assessment_pairs %}
                                                <tr id="pair-id-{{ pair.id }}">
                                                    <td>
                                                        {{ pair.learning_activity }}
                                                        <p class="help is-info">
                                                            {{ pair.note or '' }}
                                                        </p>
                                                    </td>
                                                    <td>
                                                        {{ pair.learning_activity_assessment }}
                                                    </td>
                                                    <td>
                                                        {{ pair.score_weight or 0.0 }}%
                                                    </td>
                                                    <td>
                                                        <a hx-target="#learning-activity-form"
                                                           hx-swap="innerHTML"
                                                           hx-get="{{ url_for('eduqa.edit_learning_activity', clo_id=clo.id, course_id=course.id, pair_id=pair.id) }}">
                                                           <span class="icon">
                                                               <i class="fas fa-pencil-alt has-text-primary"></i>
                                                           </span>
                                                        </a>
                                                        <a hx-delete="{{ url_for('eduqa.delete_learning_activity_assessment_pair', pair_id=pair.id) }}"
                                                           hx-swap="outerHTML swap:1s"
                                                           hx-confirm="Are you sure?"
                                                           hx-target="closest tr"
                                                        >
                                                           <span class="icon">
                                                               <i class="far fa-trash-alt has-text-danger"></i>
                                                           </span>
                                                        </a>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                            </tbody>
                                        </table>
                                    </td>
                                    <td>
                                        <a hx-get="{{ url_for('eduqa.edit_clo_plo', clo_id=clo.id) }}"
                                           hx-swap="innerHTML" hx-target="#clo-plo-form"
                                        >
                                            {{ clo.plos|length }}
                                        </a>
                                    </td>
                                    <td><span class="title is-size-5">{{ clo.score_weight }}%</span></td>
                                    <td>
                                        <a hx-get="{{ url_for('eduqa.edit_clo', course_id=course.id, clo_id=clo.id) }}"
                                           hx-target="#clo-form" hx-swap="innerHTML">
                                            <span class="icon">
                                                <i class="fas fa-pencil-alt has-text-primary"></i>
                                            </span>
                                        </a>
                                        <a hx-confirm="ต้องการลบ CLO นี้หรือไม่"
                                           hx-target="closest tr" hx-swap="outHTML"
                                           hx-delete="{{ url_for('eduqa.edit_clo', course_id=course.id, clo_id=clo.id) }}">
                                            <span class="icon">
                                                <i class="far fa-trash-alt has-text-danger"></i>
                                            </span>
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                            <tr>
                                <td></td>
                                <td></td>
                                <td><span id="clo-percent" class="title is-size-4">{{ course.total_clo_percent or 0 }}%</span></td>
                                <td></td>
                            </tr>
                            </tbody>
                        </table>
                        <div id="clo-form"></div>
                        <div id="learning-activity-form"></div>
                        <h5 class="title is-size-5">การให้เกรด</h5>
                        <ul>
                            {% for field in grading_form.grading_scheme %}
                                <li class="field">
                                    <label>
                                        {{ field(**{'hx-target': '#grading-scheme-items', 'hx-swap': 'innerHTML', 'hx-post': url_for('eduqa.update_grading_scheme', course_id=course.id)}) }}
                                        {{ field.label }}
                                    </label>
                                </li>
                            {% endfor %}
                        </ul>
                        <div id="grading-scheme-items">
                            <table class="table mt-4 mb-2">
                                <thead>
                                <th>สัญลักษณ์</th>
                                <th>คำอธิบาย</th>
                                <th>เกณฑ์</th>
                                </thead>
                                <tbody>
                                {% for item in course.grading_scheme.items %}
                                    <tr>
                                        <td>{{ item.symbol }}</td>
                                        <td>{{ item.detail or '' }}</td>
                                        <td>{{ item.criteria.filter_by(course_id=course.id).first().criteria or '' }}</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                            <button class="button is-small is-rounded is-primary"
                                    hx-target="#grading-scheme-items"
                                    hx-swap="innerHTML"
                                    hx-get="{{ url_for('eduqa.update_grading_scheme_criteria', course_id=course.id) }}">
                                        <span class="icon">
                                            <i class="fa-solid fa-pencil"></i>
                                        </span>
                                <span>แก้ไขเกณฑ์</span>
                            </button>
                        </div>
                        <h1 class="title is-size-5 mt-4">
                            การอุทธรณ์ของนักศึกษา
                        </h1>
                        <div class="field box">
                            <div class="control">
                                <div id="grade-petition">

                                    {{ course.grade_petition }}
                                    <a hx-get="{{ url_for('eduqa.edit_course_grade_petition', course_id=course.id) }}"
                                       hx-target="#grade-petition" hx-swap="innerHTML"
                                    >
                                        <span class="icon">
                                            <i class="fa-solid fa-pencil has-text-primary"></i>
                                        </span>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <h1 class="title is-size-5 mt-4">
                            การแก้ไขผลการเรียน หรือ การสอบแก้ตัว
                        </h1>
                        <div class="field box is-white">
                            <div class="control">
                                <div id="grade-correction">
                                    {{ course.grade_correction }}
                                    <a hx-get="{{ url_for('eduqa.edit_course_grade_correction', course_id=course.id) }}"
                                       hx-target="#grade-correction" hx-swap="innerHTML"
                                    >
                                        <span class="icon">
                                            <i class="fa-solid fa-pencil has-text-primary"></i>
                                        </span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <h5 class="title is-size-4" id="section-4">หมวดที่ 4 แผนการสอน</h5>
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="card-header-title">
                            <h5 class="title is-size-5">ผู้สอน</h5>
                        </div>
                    </div>
                    <div class="card-content">
                        <div id="eval-result"></div>
                        <table class="table is-bordered">
                            <thead>
                            <th>ชื่อ</th>
                            <th>สังกัด</th>
                            <th>บทบาท</th>
                            <th>ชั่วโมง</th>
                            <th>ผลประเมินการสอน</th>
                            <th>ลบ</th>
                            </thead>
                            <tbody>
                            {% for asc in course.course_instructor_associations %}
                                <tr>
                                    <td>
                                        <a href="{{ url_for('staff.show_teaching_hours_summary') }}">
                                            {{ asc.instructor.account.personal_info }}
                                        </a>
                                    </td>
                                    <td>
                                        {{ asc.instructor.account.personal_info.org }}
                                    </td>
                                    <td id="course_role">
                                        {{ asc.role.role }}
                                    </td>
                                    <td>
                                        {{ asc.instructor|total_hours(course.id)}}
                                    </td>
                                    <td>
                                        {% if current_user == asc.instructor.account or course.has_admin(current_user.instructor) %}
                                        <a class="button"
                                           hx-get="{{ url_for('eduqa.instructor_evaluation_result', course_id=course.id, instructor_id=asc.instructor.id) }}"
                                           hx-swap="innerHTML"
                                           hx-target="#eval-result"
                                        >
                                            ดูผล
                                        </a>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('eduqa.remove_instructor_from_list', course_id=course.id, instructor_id=asc.instructor.id) }}"
                                           class="is-danger is-small is-rounded">
                                                <span class="icon">
                                                    <i class="far fa-trash-alt has-text-danger"></i>
                                                </span>
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                            <tr>
                                <td colspan="6">
                                    <div id="instructor-list-modal-placeholder"></div>
                                    <div class="field has-addons">
                                        <div class="control">
                                            <a hx-get="{{ url_for('eduqa.add_instructor', course_id=course.id) }}"
                                               hx-target="#instructor-list-modal-placeholder"
                                               hx-swap="innerHTML"
                                               class="button is-light is-info">
                                                <span class="icon">
                                                   <i class="fas fa-user-plus"></i>
                                                </span>
                                                <span>เพิ่มผู้สอน</span>
                                            </a>
                                        </div>
                                        <div class="control">
                                            <a href="{{ url_for('eduqa.assign_roles', course_id=course.id) }}"
                                               class="button is-light is-info">
                                                <span class="icon">
                                                    <i class="fas fa-pencil-alt"></i>
                                                </span>
                                                <span>บทบาท</span>
                                            </a>
                                        </div>
                                    </div>
                                    <label class="label">ลิงค์แบบประเมินอาจารย์</label>
                                    <div class="field has-addons">
                                        <div class="control is-expanded">
                                            <input id="evalLink"
                                                   class="input"
                                                   readonly
                                                   value="{{ url_for('eduqa.instructor_evaluation', course_id=course.id, _external=True) }}"/>
                                        </div>
                                        <div class="control">
                                            <button class="button is-info" onclick="copyToClipboard()">Copy</button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="card-header-title">
                            <h1 class="title is-size-5">การเรียนการสอนในห้องเรียน</h1>
                        </div>
                    </div>
                    <div class="card-content">
                        <table class="table is-bordered">
                            <thead>
                            <th>วันที่</th>
                            <th>เวลา</th>
                            <th>ห้อง</th>
                            <th>หัวข้อ</th>
                            <th>CLOs</th>
                            <th>ประเภท</th>
                            <th>ผู้สอน (คลิกที่ชื่อเพื่อดูบทบาทหน้าที่)</th>
                            <th></th>
                            </thead>
                            <tbody>
                            {% for s in course.sessions|sort(attribute='start') %}
                                <tr>
                                    <td>{{s.start|localdatetime}} - {{ s.end|localdatetime }}</td>
                                    <td>
                                        {{ s.total_hours }}
                                    </td>
                                    <td class="content">
                                        <ul>
                                            {% for e in s.events %}
                                                <li>{{ e.room }}</li>
                                            {% endfor %}
                                        </ul>
                                    </td>
                                    <td class="content">
                                        <ul>
                                            {% for topic in s.topics %}
                                                <li>
                                                    {{ topic.topic }}
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    </td>
                                    <td>
                                        <ul>
                                            {% for clo in s.clos %}
                                                <li>{{ clo }}</li>
                                            {% endfor %}
                                        </ul>
                                    </td>
                                    <td>
                                        {{s.type_}}
                                        {% if s.desc %}
                                        <em>
                                            *หมายเหตุ {{ s.desc }}
                                        </em>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="tags">
                                            {% for i in s.instructors %}
                                                <a href="{{ url_for('eduqa.view_session_detail', session_id=s.id, course_id=course.id, instructor_id=i.id) }}">
                                                    <span class="tag is-rounded is-info is-light">{{ i.fullname }}</span>
                                                </a>
                                            {% endfor %}
                                        </div>
                                    </td>
                                    <td>
                                        <div class="field has-addons">
                                            <div class="control">
                                                <a class="button is-small is-rounded"
                                                   href="{{ url_for('eduqa.edit_session', session_id=s.id, course_id=course.id) }}">
                                                <span class="icon">
                                                    <i class="fas fa-pencil-alt"></i>
                                                </span>
                                                </a>
                                            </div>
                                            <div class="control">
                                                <a class="button is-small is-rounded"
                                                   href="{{ url_for('eduqa.delete_session', session_id=s.id) }}">
                                                <span class="icon">
                                                    <i class="far fa-trash-alt has-text-danger"></i>
                                                </span>
                                                </a>
                                            </div>
                                            {% if instructor in s.instructors %}
                                                <div class="control">
                                                    <a class="button is-small is-rounded"
                                                       href="{{ url_for('eduqa.add_session_detail', course_id=course.id, session_id=s.id) }}">
                                                <span class="icon">
                                                    <i class="far fa-star has-text-warning"></i>
                                                </span>
                                                    </a>
                                                </div>
                                            {% endif %}
                                            {% if admin == instructor or admin == None %}
                                                <div class="control">
                                                    <a href="{{ url_for('eduqa.duplicate_session', course_id=course.id, session_id=s.id) }}"
                                                       class="button is-rounded is-small">
                                                <span class="icon">
                                                  <i class="far fa-copy has-text-info"></i>
                                                </span>
                                                    </a>
                                                </div>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                            <tr>
                                <td colspan="7">
                                    <div class="buttons is-centered">
                                        <a href="{{ url_for('eduqa.add_session', course_id=course.id) }}"
                                           class="button is-primary is-rounded">
                                                <span class="icon">
                                                    <i class="fas fa-plus"></i>
                                                </span>
                                            <span>เพิ่มกิจกรรมในห้องเรียน</span>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            </tbody>
                        </table>

                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="card-header-title">
                            <h1 class="title is-size-5">การเรียนการสอนนอกห้องเรียน</h1>
                        </div>
                    </div>
                    <div class="card-content">
                        <table class="table is-bordered is-fullwidth">
                            <thead>
                            <th>วันที่</th>
                            <th>เวลา</th>
                            <th>หัวข้อ</th>
                            <th>ประเภท</th>
                            <th>รูปแบบ</th>
                            <th>จำนวนชั่วโมง/คน</th>
                            <th>ผู้รับผิดชอบ</th>
                            <th></th>
                            </thead>
                            <tbody>
                            {% for s in course.assignments|sort(attribute='start') %}
                                <tr>
                                    <td>{{s.start|localdatetime}} - {{ s.end|localdatetime }}</td>
                                    <td>
                                        {{ s.total_hours }}
                                    </td>
                                    <td>
                                        {{ s.title }}
                                    </td>
                                    <td>{{ s.type_ }}</td>
                                    <td>{{ s.format }}</td>
                                    <td>{{ s.workhours }}</td>
                                    <td>
                                        {% for i in s.instructors %}
                                            <a href="{{ url_for('eduqa.view_session_detail', session_id=s.id, course_id=course.id, instructor_id=i.id) }}">
                                                <span class="tag is-rounded is-info is-light">{{ i.fullname }}</span>
                                            </a>
                                        {% endfor %}
                                    </td>
                                    <td>
                                        <div class="field has-addons">
                                            <div class="control">
                                                <a class="button is-small is-rounded"
                                                   href="{{ url_for('eduqa.edit_session_assignment', session_id=s.id, course_id=course.id) }}">
                                                <span class="icon">
                                                    <i class="fas fa-pencil-alt"></i>
                                                </span>
                                                </a>
                                            </div>
                                            <div class="control">
                                                <a class="button is-small is-rounded"
                                                   href="{{ url_for('eduqa.delete_session_assignment', session_id=s.id) }}">
                                                        <span class="icon">
                                                            <i class="far fa-trash-alt has-text-danger"></i>
                                                        </span>
                                                </a>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                            <tr>
                                <td colspan="8">
                                    <div class="buttons is-centered">
                                        <a href="{{ url_for('eduqa.add_session_assignment', course_id=course.id) }}"
                                           class="button is-primary is-rounded">
                                                <span class="icon">
                                                    <i class="fas fa-plus"></i>
                                                </span>
                                            <span>เพิ่มกิจกรรมนอกห้องเรียน</span>
                                        </a>
                                        <a href="{{ url_for('studs.show_assignments', revision_id=course.revision_id, student_year=course.student_year, next_url=request.url) }}"
                                           class="button is-light is-danger is-rounded">
                                                <span class="icon">
                                                    <i class="fa-solid fa-weight-scale"></i>
                                                </span>
                                            <span>ตรวจสอบภาระงานนศ.</span>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% if not course.student_year %}
                                <tr>
                                    <td colspan="8" class="has-text-centered">
                                        <p class="help is-danger">
                                            รายวิชานี้ยังไม่ได้ระบุระดับชั้นนศ. กรุณาเพิ่มเติมข้อมูลก่อนตรวจสอบภาระงานโดย
                                            <a class="tag is-danger" href="{{ url_for('eduqa.edit_course', course_id=course.id) }}">คลิกที่นี่</a>
                                        </p>
                                    </td>
                                </tr>
                            {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <h1 class="title is-size-4" id="section-5">หมวด 5 ทรัพยากรประกอบการเรียนการสอน</h1>
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="card-header-title">
                            Required Materials
                        </div>
                    </div>
                    <div class="card-content">
                        <div id="required-materials-form"></div>
                        <table class="table is-fullwidth">
                            <thead>
                            <th>ลำดับ</th>
                            <th>รายละเอียด</th>
                            <th>
                                <button class="button is-small is-primary is-rounded"
                                        hx-target="#required-materials-form"
                                        hx-get="{{ url_for('eduqa.edit_course_material', course_id=course.id, mtype='required') }}">
                                    <span class="icon">
                                        <i class="fa-solid fa-plus"></i>
                                    </span>
                                    <span>เพิ่ม</span>
                                </button>
                            </th>
                            </thead>
                            <tbody>
                            {% for item in course.required_materials %}
                                <tr id="required-material-id-{{ item.id }}">
                                <td>{{ loop.index }}</td>
                                <td>{{ item.detail }}</td>
                                <td>
                                    <a hx-get="{{ url_for('eduqa.edit_course_material', course_id=course.id, item_id=item.id, mtype='required') }}"
                                       hx-target="#required-materials-form" hx-swap="innerHTML">
                                        <span class="icon">
                                            <i class="fas fa-pencil-alt has-text-primary"></i>
                                        </span>
                                    </a>
                                    <a hx-confirm="Are you sure want to delete this item?"
                                       hx-delete="{{ url_for('eduqa.edit_course_material', course_id=course.id, item_id=item.id, mtype='required') }}">
                                        <span class="icon">
                                            <i class="far fa-trash-alt has-text-danger"></i>
                                        </span>
                                    </a>
                                </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="card-header-title">
                            Suggested Materials
                        </div>
                    </div>
                    <div class="card-content">
                        <div id="suggested-materials-form"></div>
                        <table class="table is-fullwidth">
                            <thead>
                            <th>ลำดับ</th>
                            <th>รายละเอียด</th>
                            <th>
                                <button class="button is-small is-primary is-rounded"
                                        hx-target="#suggested-materials-form"
                                        hx-get="{{ url_for('eduqa.edit_course_material', course_id=course.id, mtype='suggested') }}">
                                    <span class="icon">
                                        <i class="fa-solid fa-plus"></i>
                                    </span>
                                    <span>เพิ่ม</span>
                                </button>
                            </th>
                            </thead>
                            <tbody>
                            {% for item in course.suggested_materials %}
                                <tr id="suggested-material-id-{{ item.id }}">
                                    <td>{{ loop.index }}</td>
                                    <td>{{ item.detail }}</td>
                                    <td>
                                        <a hx-get="{{ url_for('eduqa.edit_course_material', course_id=course.id, item_id=item.id, mtype='suggested') }}"
                                           hx-target="#suggested-materials-form" hx-swap="innerHTML">
                                        <span class="icon">
                                            <i class="fas fa-pencil-alt has-text-primary"></i>
                                        </span>
                                        </a>
                                        <a hx-confirm="Are you sure want to delete this item?"
                                           hx-delete="{{ url_for('eduqa.edit_course_material', course_id=course.id, item_id=item.id, mtype='suggested') }}">
                                        <span class="icon">
                                            <i class="far fa-trash-alt has-text-danger"></i>
                                        </span>
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="card-header-title">
                            Other Resources
                        </div>
                    </div>
                    <div class="card-content">
                        <div id="resource-materials-form"></div>
                        <table class="table is-fullwidth">
                            <thead>
                            <th>ลำดับ</th>
                            <th>รายละเอียด</th>
                            <th>
                                <button class="button is-small is-primary is-rounded"
                                        hx-target="#resource-materials-form"
                                        hx-get="{{ url_for('eduqa.edit_course_material', course_id=course.id, mtype='resource') }}">
                                    <span class="icon">
                                        <i class="fa-solid fa-plus"></i>
                                    </span>
                                    <span>เพิ่ม</span>
                                </button>
                            </th>
                            </thead>
                            <tbody>
                            {% for item in course.resources %}
                                <tr id="resources-material-id-{{ item.id }}">
                                    <td>{{ loop.index }}</td>
                                    <td>{{ item.detail }}</td>
                                    <td>
                                        <a hx-get="{{ url_for('eduqa.edit_course_material', course_id=course.id, item_id=item.id, mtype='resource') }}"
                                           hx-target="#resource-materials-form" hx-swap="innerHTML">
                                        <span class="icon">
                                            <i class="fas fa-pencil-alt has-text-primary"></i>
                                        </span>
                                        </a>
                                        <a hx-confirm="Are you sure want to delete this item?"
                                           hx-delete="{{ url_for('eduqa.edit_course_material', course_id=course.id, item_id=item.id, mtype='resource') }}">
                                        <span class="icon">
                                            <i class="far fa-trash-alt has-text-danger"></i>
                                        </span>
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <h5 class="title is-size-4" id="section-6">หมวด 6 การประเมินและการปรับปรุงการดำเนินการ</h5>
                <div class="card mb-4">
                    <div class="card-header">
                        <div class="card-header-title">
                            แผนการดำเนินการ
                        </div>
                    </div>
                    <div class="card-content">
                        <label class="label">
                            การทบทวนและการวางแผนปรับปรุงรายวิชา
                        </label>
                        <div class="field box">
                            <div class="control">
                                <div id="revision-plan">
                                    {{ course.revision_plan }}
                                    <a hx-get="{{ url_for('eduqa.edit_course_revision_plan', course_id=course.id) }}"
                                       hx-target="#revision-plan" hx-swap="innerHTML"
                                    >
                                        <span class="icon">
                                            <i class="fa-solid fa-pencil has-text-primary"></i>
                                        </span>
                                    </a>
                                </div>
                            </div>
                        </div>
                        <label class="label">
                            การจัดทำรายงานการประเมินตนเองของรายวิชา
                        </label>
                        <div class="field box">
                            <div class="control">
                                <div id="evaluation-plan">
                                    {{ course.evaluation_plan }}
                                    <a hx-get="{{ url_for('eduqa.edit_course_evaluation_plan', course_id=course.id) }}"
                                       hx-target="#evaluation-plan" hx-swap="innerHTML"
                                    >
                                        <span class="icon">
                                            <i class="fa-solid fa-pencil has-text-primary"></i>
                                        </span>
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="buttons is-centered">
                    <a class="button is-rounded is-light" href="{{ url_for('eduqa.show_revision_detail', revision_id=course.revision.id) }}">
                        Back
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock %}
{% block scripts %}
{{ super() }}
<script type="text/javascript" src="//fastly.jsdelivr.net/momentjs/latest/moment-with-locales.min.js"></script>
<script type="text/javascript" src="https://fastly.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js" defer></script>
<script src="https://fastly.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    vm = new Vue({
        el: '#app',
        methods: {
            warn: function() {
                this.$buefy.dialog.confirm({
                    message: 'ต้องการลบรายวิชานี้จริงหรือไม่',
                    onConfirm: ()=> window.location.href = "{{ url_for('eduqa.delete_course', course_id=course.id) }}",
                    type: 'is-danger'
                })
            }
        }
    })
    $(document).ready(function () {
        document.body.addEventListener('htmx:configRequest', function(evt) {
            evt.detail.headers['X-CSRF-Token'] = {{ csrf_token()|tojson|safe }}; // add a new parameter into the mix
        });
        document.addEventListener("closeModal", function(evt){
            htmx.removeClass(htmx.find('#clo-form'), 'is-active')
            let total = evt.detail.value
            $('#clo-percent').html('รวม ' + total + '%')
        })
    })
    function copyToClipboard() {
  // Get the text field
      let copyText = document.getElementById("evalLink");

      // Select the text field
      copyText.select();
      copyText.setSelectionRange(0, 99999); // For mobile devices

       // Copy the text inside the text field
      navigator.clipboard.writeText(copyText.value).then(()=>{
            alert("Copied!");
        }).catch(()=>{
          alert("Failed to copy!");
      });

      // Alert the copied text
    }
</script>
{% endblock %}

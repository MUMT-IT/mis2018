{% extends "continueing_edu/base_frontend.html" %}

{% block title %}{{ texts.get('verify_reset_otp', 'ยืนยัน OTP' if current_lang == 'th' else 'Verify OTP') }} - Reset
Password{% endblock %}

{% block extra_css %}
{{ super() }}
<style>
          :root {
                    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
          }

          .verify-otp-container {
                    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                    min-height: 100vh;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 1rem;
          }

          .verify-hero {
                    background: var(--primary-gradient);
                    padding: 2rem 1.5rem;
                    border-radius: 16px 16px 0 0;
                    text-align: center;
                    color: white;
          }

          .hero-icon {
                    font-size: 3rem;
                    margin-bottom: 1rem;
          }

          .hero-title {
                    font-size: 2rem;
                    font-weight: 700;
                    margin-bottom: 0.5rem;
          }

          .hero-subtitle {
                    font-size: 1rem;
                    opacity: 0.95;
          }

          .modern-card {
                    background: rgba(255, 255, 255, 0.95);
                    backdrop-filter: blur(10px);
                    border-radius: 16px;
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    box-shadow: var(--card-shadow);
                    max-width: 500px;
                    width: 100%;
                    overflow: hidden;
          }

          .card-body {
                    padding: 2.5rem;
          }

          .otp-input-group {
                    display: flex;
                    gap: 1rem;
                    justify-content: center;
                    margin: 2rem 0;
          }

          .otp-input {
                    width: 3.5rem;
                    height: 3.5rem;
                    text-align: center;
                    font-size: 1.5rem;
                    font-weight: 700;
                    border: 2px solid #e0e7ff;
                    border-radius: 8px;
                    transition: all 0.3s ease;
          }

          .otp-input:focus {
                    border-color: #667eea;
                    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                    outline: none;
          }

          .btn-primary {
                    background: var(--primary-gradient);
                    border: none;
                    color: white;
                    padding: 0.875rem 2rem;
                    border-radius: 8px;
                    font-weight: 600;
                    font-size: 1rem;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
                    width: 100%;
          }

          .btn-primary:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
          }

          .timer {
                    text-align: center;
                    margin-top: 1rem;
                    color: #7a7a7a;
                    font-size: 0.95rem;
          }

          .timer.warning {
                    color: #f14668;
                    font-weight: 600;
          }

          .info-box {
                    background: rgba(102, 126, 234, 0.05);
                    border-left: 4px solid #667eea;
                    padding: 1rem;
                    border-radius: 8px;
                    margin-bottom: 1.5rem;
                    font-size: 0.95rem;
          }

          .back-link {
                    text-align: center;
                    margin-top: 1.5rem;
          }

          .back-link a {
                    color: #667eea;
                    font-weight: 600;
                    text-decoration: none;
          }

          @keyframes fadeInUp {
                    from {
                              opacity: 0;
                              transform: translateY(20px);
                    }

                    to {
                              opacity: 1;
                              transform: translateY(0);
                    }
          }

          .animate-in {
                    animation: fadeInUp 0.6s ease-out;
          }
</style>
{% endblock %}

{% block content %}
<div class="verify-otp-container">
          <div class="modern-card animate-in">
                    <div class="verify-hero">
                              <div class="hero-icon">
                                        <i class="fas fa-shield-alt"></i>
                              </div>
                              <h1 class="hero-title">{{ texts.get('verify_otp', 'ยืนยัน OTP' if current_lang == 'th'
                                        else 'Verify OTP') }}</h1>
                              <p class="hero-subtitle">
                                        {{ texts.get('reset_password_verification', 'ยืนยันตัวตนเพื่อรีเซ็ตรหัสผ่าน' if
                                        current_lang == 'th' else 'Verify your identity to reset password') }}
                              </p>
                    </div>

                    <div class="card-body">
                              <div class="info-box">
                                        <i class="fas fa-info-circle" style="color: #667eea; margin-right: 0.5rem;"></i>
                                        {{ texts.get('otp_sent_username', 'รหัส OTP ถูกส่งไปยังอีเมลของ' if current_lang
                                        == 'th' else 'OTP code has been sent to the email of') }}
                                        <strong>{{ username }}</strong>
                              </div>

                              <form method="POST"
                                        action="{{ url_for('continuing_edu.verify_reset_otp', lang=current_lang) }}"
                                        id="otp-form">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <input type="hidden" name="username" value="{{ username }}">

                                        <div class="otp-input-group">
                                                  <input type="text" class="otp-input" maxlength="1" pattern="[0-9]"
                                                            inputmode="numeric" required>
                                                  <input type="text" class="otp-input" maxlength="1" pattern="[0-9]"
                                                            inputmode="numeric" required>
                                                  <input type="text" class="otp-input" maxlength="1" pattern="[0-9]"
                                                            inputmode="numeric" required>
                                                  <input type="text" class="otp-input" maxlength="1" pattern="[0-9]"
                                                            inputmode="numeric" required>
                                                  <input type="text" class="otp-input" maxlength="1" pattern="[0-9]"
                                                            inputmode="numeric" required>
                                                  <input type="text" class="otp-input" maxlength="1" pattern="[0-9]"
                                                            inputmode="numeric" required>
                                        </div>

                                        <input type="hidden" name="otp_code" id="otp-value">

                                        <div class="timer" id="timer">
                                                  {{ texts.get('otp_expires_in', 'รหัสหมดอายุใน' if current_lang == 'th'
                                                  else 'Code expires in') }}
                                                  <span id="countdown">15:00</span>
                                        </div>

                                        <div class="field" style="margin-top: 2rem;">
                                                  <button class="btn-primary" type="submit">
                                                            <i class="fas fa-check-circle"></i>
                                                            <span>{{ texts.get('verify_continue',
                                                                      'ยืนยันและดำเนินการต่อ' if current_lang == 'th'
                                                                      else 'Verify & Continue') }}</span>
                                                  </button>
                                        </div>
                              </form>

                              <div class="back-link">
                                        <a href="{{ url_for('continuing_edu.forgot_password', lang=current_lang) }}">
                                                  <i class="fas fa-arrow-left"></i>
                                                  {{ texts.get('back_forgot_password', 'กลับไปขอรหัสใหม่' if
                                                  current_lang == 'th' else 'Back to Request OTP') }}
                                        </a>
                              </div>

                              <div class="back-link">
                                        <a href="{{ url_for('continuing_edu.login', lang=current_lang) }}">
                                                  <i class="fas fa-sign-in-alt"></i>
                                                  {{ texts.get('back_to_login', 'กลับไปหน้าเข้าสู่ระบบ' if current_lang
                                                  == 'th' else 'Back to Login') }}
                                        </a>
                              </div>
                    </div>
          </div>
</div>

<script>
          document.addEventListener('DOMContentLoaded', () => {
                    const otpInputs = document.querySelectorAll('.otp-input');
                    const otpForm = document.getElementById('otp-form');
                    const otpValue = document.getElementById('otp-value');
                    const countdown = document.getElementById('countdown');
                    const timer = document.getElementById('timer');

                    // OTP Input Auto-focus and Navigation
                    otpInputs.forEach((input, index) => {
                              input.addEventListener('input', (e) => {
                                        if (e.target.value.length === 1 && index < otpInputs.length - 1) {
                                                  otpInputs[index + 1].focus();
                                        }
                              });

                              input.addEventListener('keydown', (e) => {
                                        if (e.key === 'Backspace' && !e.target.value && index > 0) {
                                                  otpInputs[index - 1].focus();
                                        }
                              });

                              input.addEventListener('paste', (e) => {
                                        e.preventDefault();
                                        const pastedData = e.clipboardData.getData('text').slice(0, 6);
                                        pastedData.split('').forEach((char, i) => {
                                                  if (otpInputs[i] && /[0-9]/.test(char)) {
                                                            otpInputs[i].value = char;
                                                  }
                                        });
                                        if (otpInputs[pastedData.length]) {
                                                  otpInputs[pastedData.length].focus();
                                        }
                              });
                    });

                    // Form Submit
                    otpForm.addEventListener('submit', (e) => {
                              e.preventDefault();
                              const otp = Array.from(otpInputs).map(input => input.value).join('');
                              if (otp.length === 6) {
                                        otpValue.value = otp;
                                        otpForm.submit();
                              } else {
                                        alert('{{ texts.get("otp_incomplete", "กรุณากรอก OTP ให้ครบ 6 หลัก" if current_lang == "th" else "Please enter all 6 digits") }}');
                              }
                    });

                    // Countdown Timer (15 minutes)
                    let timeLeft = 15 * 60;
                    const countdownInterval = setInterval(() => {
                              timeLeft--;
                              const minutes = Math.floor(timeLeft / 60);
                              const seconds = timeLeft % 60;
                              countdown.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;

                              if (timeLeft <= 60) {
                                        timer.classList.add('warning');
                              }

                              if (timeLeft <= 0) {
                                        clearInterval(countdownInterval);
                                        countdown.textContent = '{{ texts.get("otp_expired", "หมดอายุแล้ว" if current_lang == "th" else "Expired") }}';
                                        otpInputs.forEach(input => input.disabled = true);
                                        alert('{{ texts.get("otp_expired_msg", "OTP หมดอายุแล้ว กรุณาขอรหัสใหม่" if current_lang == "th" else "OTP expired. Please request a new one") }}');
                              }
                    }, 1000);

                    // Close notification
                    document.querySelectorAll('.notification .delete').forEach(($delete) => {
                              $delete.addEventListener('click', () => {
                                        $delete.parentNode.remove();
                              });
                    });

                    // Auto-focus first input
                    otpInputs[0].focus();
          });
</script>
{% endblock %}

{% block extra_js %}
{% endblock %}
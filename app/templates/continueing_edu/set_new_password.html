{% extends "continueing_edu/base_frontend.html" %}

{% block title %}{{ texts.get('set_new_password', 'ตั้งรหัสผ่านใหม่' if current_lang == 'th' else 'Set New Password')
}}{% endblock %}

{% block extra_css %}
{{ super() }}
<style>
          :root {
                    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    --success-gradient: linear-gradient(135deg, #48c774 0%, #3db65e 100%);
                    --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
          }

          .set-password-container {
                    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
                    min-height: 100vh;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 1rem;
          }

          .password-hero {
                    background: var(--success-gradient);
                    padding: 2rem 1.5rem;
                    border-radius: 16px 16px 0 0;
                    text-align: center;
                    color: white;
          }

          .hero-icon {
                    font-size: 3rem;
                    margin-bottom: 1rem;
          }

          .hero-title {
                    font-size: 2rem;
                    font-weight: 700;
                    margin-bottom: 0.5rem;
          }

          .hero-subtitle {
                    font-size: 1rem;
                    opacity: 0.95;
          }

          .modern-card {
                    background: rgba(255, 255, 255, 0.95);
                    backdrop-filter: blur(10px);
                    border-radius: 16px;
                    border: 1px solid rgba(255, 255, 255, 0.2);
                    box-shadow: var(--card-shadow);
                    max-width: 600px;
                    width: 100%;
                    overflow: hidden;
          }

          .card-body {
                    padding: 2.5rem;
          }

          .modern-input {
                    border: 2px solid #e0e7ff;
                    border-radius: 8px;
                    padding: 0.75rem 1rem;
                    font-size: 1rem;
                    transition: all 0.3s ease;
                    background: white;
          }

          .modern-input:focus {
                    border-color: #667eea;
                    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                    outline: none;
          }

          .modern-label {
                    font-weight: 600;
                    color: #374151;
                    margin-bottom: 0.5rem;
                    display: block;
          }

          .field-icon {
                    color: #667eea;
                    margin-right: 0.5rem;
          }

          .password-toggle-wrapper {
                    position: relative;
          }

          .password-toggle-icon {
                    position: absolute;
                    right: 12px;
                    top: 50%;
                    transform: translateY(-50%);
                    cursor: pointer;
                    color: #9ca3af;
                    transition: color 0.2s ease;
                    z-index: 10;
                    padding: 8px;
          }

          .password-toggle-icon:hover {
                    color: #667eea;
          }

          .password-toggle-wrapper input {
                    padding-right: 45px;
          }

          .password-strength-container {
                    width: 100%;
                    margin-top: 0.5rem;
          }

          .password-strength-bar {
                    height: 6px;
                    background: #e0e7ff;
                    border-radius: 3px;
                    overflow: hidden;
                    margin-bottom: 0.5rem;
          }

          .password-strength-fill {
                    height: 100%;
                    width: 0%;
                    transition: all 0.3s ease;
                    border-radius: 3px;
          }

          .password-strength-fill.weak {
                    width: 25%;
                    background: linear-gradient(90deg, #f14668, #ff6b9d);
          }

          .password-strength-fill.fair {
                    width: 50%;
                    background: linear-gradient(90deg, #ffdd57, #ffa500);
          }

          .password-strength-fill.good {
                    width: 75%;
                    background: linear-gradient(90deg, #48c774, #2ecc71);
          }

          .password-strength-fill.strong {
                    width: 100%;
                    background: linear-gradient(90deg, #00d1b2, #00b89c);
          }

          .password-strength-text {
                    font-size: 0.875rem;
                    font-weight: 600;
                    margin: 0;
          }

          .password-strength-text.weak {
                    color: #f14668;
          }

          .password-strength-text.fair {
                    color: #ffa500;
          }

          .password-strength-text.good {
                    color: #48c774;
          }

          .password-strength-text.strong {
                    color: #00d1b2;
          }

          .password-requirements {
                    margin-top: 0.75rem;
                    font-size: 0.875rem;
          }

          .password-requirements ul {
                    list-style: none;
                    padding-left: 0;
          }

          .requirement-item {
                    color: #7a7a7a;
                    margin-bottom: 0.25rem;
                    transition: all 0.2s ease;
                    display: flex;
                    align-items: center;
          }

          .requirement-item.met {
                    color: #48c774;
          }

          .requirement-item.met i {
                    color: #48c774;
          }

          .requirement-item i {
                    color: #e0e7ff;
                    font-size: 0.75rem;
                    margin-right: 0.5rem;
                    min-width: 14px;
          }

          .help-text {
                    font-size: 0.875rem;
                    margin-top: 0.25rem;
                    color: #7a7a7a;
          }

          .help-text.is-danger {
                    color: #f14668;
          }

          .help-text.is-success {
                    color: #48c774;
          }

          .field-success {
                    border-color: #48c774;
          }

          .field-error {
                    border-color: #f14668;
          }

          .btn-primary {
                    background: var(--primary-gradient);
                    border: none;
                    color: white;
                    padding: 0.875rem 2rem;
                    border-radius: 8px;
                    font-weight: 600;
                    font-size: 1rem;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
                    width: 100%;
          }

          .btn-primary:hover:not(:disabled) {
                    transform: translateY(-2px);
                    box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
          }

          .btn-primary:disabled {
                    opacity: 0.6;
                    cursor: not-allowed;
          }

          @keyframes fadeInUp {
                    from {
                              opacity: 0;
                              transform: translateY(20px);
                    }

                    to {
                              opacity: 1;
                              transform: translateY(0);
                    }
          }

          .animate-in {
                    animation: fadeInUp 0.6s ease-out;
          }
</style>
{% endblock %}

{% block content %}
<div class="set-password-container">
          <div class="modern-card animate-in">
                    <div class="password-hero">
                              <div class="hero-icon">
                                        <i class="fas fa-check-circle"></i>
                              </div>
                              <h1 class="hero-title">{{ texts.get('set_new_password', 'ตั้งรหัสผ่านใหม่' if current_lang
                                        == 'th' else 'Set New Password') }}</h1>
                              <p class="hero-subtitle">
                                        {{ texts.get('create_strong_password', 'สร้างรหัสผ่านที่แข็งแรงและปลอดภัย' if
                                        current_lang == 'th' else 'Create a strong and secure password') }}
                              </p>
                    </div>

                    <div class="card-body">
                              <form method="POST"
                                        action="{{ url_for('continuing_edu.set_new_password', lang=current_lang) }}"
                                        id="password-form">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <input type="hidden" name="reset_token" value="{{ reset_token }}">

                                        <div class="field">
                                                  <label class="modern-label">
                                                            <i class="fas fa-lock field-icon"></i>
                                                            {{ texts.get('new_password', 'รหัสผ่านใหม่' if current_lang
                                                            == 'th' else 'New Password') }}*
                                                  </label>
                                                  <div class="control password-toggle-wrapper">
                                                            <input class="input modern-input" type="password"
                                                                      name="new_password" id="password-input" required
                                                                      minlength="8"
                                                                      pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$"
                                                                      placeholder="{{ texts.get('password_placeholder', 'อย่างน้อย 8 ตัวอักษร' if current_lang == 'th' else 'At least 8 characters') }}">
                                                            <i class="fas fa-eye password-toggle-icon"
                                                                      id="toggle-password"
                                                                      title="{{ texts.get('show_password', 'แสดงรหัสผ่าน' if current_lang == 'th' else 'Show password') }}"></i>
                                                  </div>
                                                  <div class="password-strength-container">
                                                            <div class="password-strength-bar">
                                                                      <div class="password-strength-fill"
                                                                                id="password-strength-fill"></div>
                                                            </div>
                                                            <p class="password-strength-text"
                                                                      id="password-strength-text"></p>
                                                  </div>
                                                  <div class="password-requirements">
                                                            <p
                                                                      style="font-weight: 600; color: #667eea; margin-bottom: 0.5rem;">
                                                                      {{ texts.get('password_requirements',
                                                                      'รหัสผ่านต้องมี:' if current_lang == 'th' else
                                                                      'Password must have:') }}
                                                            </p>
                                                            <ul>
                                                                      <li id="req-length" class="requirement-item">
                                                                                <i class="fas fa-circle"></i>
                                                                                <span>{{ texts.get('req_length',
                                                                                          'อย่างน้อย 8 ตัวอักษร' if
                                                                                          current_lang == 'th' else 'At
                                                                                          least 8 characters') }}</span>
                                                                      </li>
                                                                      <li id="req-uppercase" class="requirement-item">
                                                                                <i class="fas fa-circle"></i>
                                                                                <span>{{ texts.get('req_uppercase',
                                                                                          'ตัวพิมพ์ใหญ่อย่างน้อย 1 ตัว
                                                                                          (A-Z)' if current_lang == 'th'
                                                                                          else 'At least 1 uppercase
                                                                                          letter (A-Z)') }}</span>
                                                                      </li>
                                                                      <li id="req-lowercase" class="requirement-item">
                                                                                <i class="fas fa-circle"></i>
                                                                                <span>{{ texts.get('req_lowercase',
                                                                                          'ตัวพิมพ์เล็กอย่างน้อย 1 ตัว
                                                                                          (a-z)' if current_lang == 'th'
                                                                                          else 'At least 1 lowercase
                                                                                          letter (a-z)') }}</span>
                                                                      </li>
                                                                      <li id="req-number" class="requirement-item">
                                                                                <i class="fas fa-circle"></i>
                                                                                <span>{{ texts.get('req_number',
                                                                                          'ตัวเลขอย่างน้อย 1 ตัว (0-9)'
                                                                                          if current_lang == 'th' else
                                                                                          'At least 1 number (0-9)')
                                                                                          }}</span>
                                                                      </li>
                                                                      <li id="req-special" class="requirement-item">
                                                                                <i class="fas fa-circle"></i>
                                                                                <span>{{ texts.get('req_special',
                                                                                          'อักขระพิเศษอย่างน้อย 1 ตัว
                                                                                          (@$!%*?&)' if current_lang ==
                                                                                          'th' else 'At least 1 special
                                                                                          character (@$!%*?&)')
                                                                                          }}</span>
                                                                      </li>
                                                            </ul>
                                                  </div>
                                        </div>

                                        <div class="field" style="margin-top: 1.5rem;">
                                                  <label class="modern-label">
                                                            <i class="fas fa-lock field-icon"></i>
                                                            {{ texts.get('confirm_password', 'ยืนยันรหัสผ่าน' if
                                                            current_lang == 'th' else 'Confirm Password') }}*
                                                  </label>
                                                  <div class="control password-toggle-wrapper">
                                                            <input class="input modern-input" type="password"
                                                                      name="confirm_password"
                                                                      id="confirm-password-input" required
                                                                      placeholder="{{ texts.get('confirm_password_placeholder', 'พิมพ์รหัสผ่านอีกครั้ง' if current_lang == 'th' else 'Re-enter password') }}">
                                                            <i class="fas fa-eye password-toggle-icon"
                                                                      id="toggle-confirm-password"
                                                                      title="{{ texts.get('show_password', 'แสดงรหัสผ่าน' if current_lang == 'th' else 'Show password') }}"></i>
                                                  </div>
                                                  <p class="help-text" id="password-match-message"></p>
                                        </div>

                                        <div class="field" style="margin-top: 2rem;">
                                                  <button class="btn-primary" type="submit" id="submit-btn">
                                                            <i class="fas fa-save"></i>
                                                            <span>{{ texts.get('save_password', 'บันทึกรหัสผ่าน' if
                                                                      current_lang == 'th' else 'Save Password')
                                                                      }}</span>
                                                  </button>
                                        </div>
                              </form>
                    </div>
          </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
          document.addEventListener('DOMContentLoaded', () => {
                    const passwordInput = document.getElementById('password-input');
                    const confirmPasswordInput = document.getElementById('confirm-password-input');
                    const passwordMatchMessage = document.getElementById('password-match-message');
                    const strengthFill = document.getElementById('password-strength-fill');
                    const strengthText = document.getElementById('password-strength-text');

                    const reqLength = document.getElementById('req-length');
                    const reqUppercase = document.getElementById('req-uppercase');
                    const reqLowercase = document.getElementById('req-lowercase');
                    const reqNumber = document.getElementById('req-number');
                    const reqSpecial = document.getElementById('req-special');

                    function checkPasswordStrength(password) {
                              let strength = 0;
                              const requirements = {
                                        length: password.length >= 8,
                                        uppercase: /[A-Z]/.test(password),
                                        lowercase: /[a-z]/.test(password),
                                        number: /\d/.test(password),
                                        special: /[@$!%*?&]/.test(password)
                              };

                              updateRequirement(reqLength, requirements.length);
                              updateRequirement(reqUppercase, requirements.uppercase);
                              updateRequirement(reqLowercase, requirements.lowercase);
                              updateRequirement(reqNumber, requirements.number);
                              updateRequirement(reqSpecial, requirements.special);

                              Object.values(requirements).forEach(met => {
                                        if (met) strength++;
                              });

                              const strengthLevels = {
                                        0: { class: '', text: '' },
                                        1: { class: 'weak', text: '{{ texts.get("password_weak", "อ่อนแอ" if current_lang == "th" else "Weak") }}' },
                                        2: { class: 'weak', text: '{{ texts.get("password_weak", "อ่อนแอ" if current_lang == "th" else "Weak") }}' },
                                        3: { class: 'fair', text: '{{ texts.get("password_fair", "พอใช้" if current_lang == "th" else "Fair") }}' },
                                        4: { class: 'good', text: '{{ texts.get("password_good", "ดี" if current_lang == "th" else "Good") }}' },
                                        5: { class: 'strong', text: '{{ texts.get("password_strong", "แข็งแรง" if current_lang == "th" else "Strong") }}' }
                              };

                              const level = strengthLevels[strength];

                              if (strengthFill && strengthText) {
                                        strengthFill.className = 'password-strength-fill';
                                        strengthText.className = 'password-strength-text';

                                        if (password.length > 0) {
                                                  strengthFill.classList.add(level.class);
                                                  strengthText.classList.add(level.class);
                                                  strengthText.textContent = level.text;
                                        } else {
                                                  strengthText.textContent = '';
                                        }
                              }

                              return strength === 5;
                    }

                    function updateRequirement(element, isMet) {
                              if (!element) return;

                              if (isMet) {
                                        element.classList.add('met');
                                        const icon = element.querySelector('i');
                                        if (icon) {
                                                  icon.className = 'fas fa-check-circle';
                                        }
                              } else {
                                        element.classList.remove('met');
                                        const icon = element.querySelector('i');
                                        if (icon) {
                                                  icon.className = 'fas fa-circle';
                                        }
                              }
                    }

                    function validatePasswordMatch() {
                              const password = passwordInput.value;
                              const confirmPassword = confirmPasswordInput.value;

                              if (confirmPassword.length === 0) {
                                        passwordMatchMessage.textContent = '';
                                        passwordMatchMessage.className = 'help-text';
                                        confirmPasswordInput.classList.remove('field-success', 'field-error');
                                        return;
                              }

                              if (password === confirmPassword) {
                                        passwordMatchMessage.textContent = '✓ {{ texts.get("password_match", "รหัสผ่านตรงกัน" if current_lang == "th" else "Passwords match") }}';
                                        passwordMatchMessage.className = 'help-text is-success';
                                        confirmPasswordInput.classList.remove('field-error');
                                        confirmPasswordInput.classList.add('field-success');
                              } else {
                                        passwordMatchMessage.textContent = '✗ {{ texts.get("password_no_match", "รหัสผ่านไม่ตรงกัน" if current_lang == "th" else "Passwords do not match") }}';
                                        passwordMatchMessage.className = 'help-text is-danger';
                                        confirmPasswordInput.classList.remove('field-success');
                                        confirmPasswordInput.classList.add('field-error');
                              }
                    }

                    if (passwordInput) {
                              passwordInput.addEventListener('input', function () {
                                        checkPasswordStrength(this.value);
                                        if (confirmPasswordInput && confirmPasswordInput.value.length > 0) {
                                                  validatePasswordMatch();
                                        }
                              });
                    }

                    if (confirmPasswordInput) {
                              confirmPasswordInput.addEventListener('input', validatePasswordMatch);
                              confirmPasswordInput.addEventListener('blur', validatePasswordMatch);
                    }

                    const togglePassword = document.getElementById('toggle-password');
                    const toggleConfirmPassword = document.getElementById('toggle-confirm-password');

                    if (togglePassword && passwordInput) {
                              togglePassword.addEventListener('click', function () {
                                        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                                        passwordInput.setAttribute('type', type);

                                        if (type === 'text') {
                                                  this.classList.remove('fa-eye');
                                                  this.classList.add('fa-eye-slash');
                                                  this.setAttribute('title', '{{ texts.get("hide_password", "ซ่อนรหัสผ่าน" if current_lang == "th" else "Hide password") }}');
                                        } else {
                                                  this.classList.remove('fa-eye-slash');
                                                  this.classList.add('fa-eye');
                                                  this.setAttribute('title', '{{ texts.get("show_password", "แสดงรหัสผ่าน" if current_lang == "th" else "Show password") }}');
                                        }
                              });
                    }

                    if (toggleConfirmPassword && confirmPasswordInput) {
                              toggleConfirmPassword.addEventListener('click', function () {
                                        const type = confirmPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
                                        confirmPasswordInput.setAttribute('type', type);

                                        if (type === 'text') {
                                                  this.classList.remove('fa-eye');
                                                  this.classList.add('fa-eye-slash');
                                                  this.setAttribute('title', '{{ texts.get("hide_password", "ซ่อนรหัสผ่าน" if current_lang == "th" else "Hide password") }}');
                                        } else {
                                                  this.classList.remove('fa-eye-slash');
                                                  this.classList.add('fa-eye');
                                                  this.setAttribute('title', '{{ texts.get("show_password", "แสดงรหัสผ่าน" if current_lang == "th" else "Show password") }}');
                                        }
                              });
                    }

                    document.querySelectorAll('.notification .delete').forEach(($delete) => {
                              $delete.addEventListener('click', () => {
                                        $delete.parentNode.remove();
                              });
                    });
          });
</script>
{% endblock %}
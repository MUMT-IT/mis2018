{% extends 'continueing_edu/admin/base.html' %}
{% block title %}Member Report{% endblock %}
{% block content %}
<div class="container">
  <div class="level">
    <div class="level-left">
      <h1 class="title">Member Engagement Report</h1>
    </div>
    <div class="level-right">
      <span class="tag is-light">Members {{ total_members }}</span>
    </div>
  </div>

  <form class="box" method="get">
    <div class="columns is-multiline">
      <div class="column is-3">
        <label class="label">Search</label>
        <input class="input" type="text" name="q" value="{{ q or '' }}" placeholder="Name / Username / Email">
      </div>
      <div class="column is-3">
        <label class="label">Member Type</label>
        <div class="select is-fullwidth">
          <select name="member_type_id">
            <option value="">All</option>
            {% for mt in member_types %}
              <option value="{{ mt.id }}" {% if member_type_id == mt.id|string %}selected{% endif %}>{{ mt.name_en }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="column is-2">
        <label class="label">Verified</label>
        <div class="select is-fullwidth">
          <select name="is_verified">
            <option value="">All</option>
            <option value="1" {% if verified == '1' %}selected{% endif %}>Yes</option>
            <option value="0" {% if verified == '0' %}selected{% endif %}>No</option>
          </select>
        </div>
      </div>
      <div class="column is-2">
        <label class="label">Joined After</label>
        <input class="input" type="date" name="start" value="{{ start_value or '' }}">
      </div>
      <div class="column is-2">
        <label class="label">Joined Before</label>
        <input class="input" type="date" name="end" value="{{ end_value or '' }}">
      </div>
      <div class="column is-2">
        <label class="label">Rows</label>
        <div class="select is-fullwidth">
          <select name="per_page">
            {% for size in [25, 50, 100] %}
              <option value="{{ size }}" {% if pagination.per_page == size %}selected{% endif %}>{{ size }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="column is-2">
        <label class="label">&nbsp;</label>
        <button class="button is-link is-fullwidth" type="submit">Filter</button>
      </div>
    </div>
  </form>

  <div class="columns is-multiline">
    <div class="column is-one-third">
      <div class="box has-background-primary has-text-white">
        <p class="heading">Members</p>
        <p class="title is-3">{{ total_members }}</p>
      </div>
    </div>
    <div class="column is-one-third">
      <div class="box has-background-link has-text-white">
        <p class="heading">Registrations</p>
        <p class="title is-3">{{ total_registrations }}</p>
      </div>
    </div>
    <div class="column is-one-third">
      <div class="box has-background-success has-text-white">
        <p class="heading">Payments (THB)</p>
        <p class="title is-3">{{ "{:,.2f}".format(total_payments) }}</p>
      </div>
    </div>
  </div>

  <div class="box">
    <div class="table-container">
      <table class="table is-fullwidth is-striped is-hoverable">
        <thead>
          <tr>
            <th>Member</th>
            <th>Email</th>
            <th>Type</th>
            <th>Created</th>
            <th class="has-text-right">Registrations</th>
            <th>Last Registration</th>
            <th class="has-text-right">Payments (THB)</th>
            <th>Last Payment</th>
          </tr>
        </thead>
        <tbody>
          {% for row in members_data %}
          <tr>
            <td>{{ row.member.full_name_en or row.member.full_name_th or row.member.username }}</td>
            <td>{{ row.member.email or '-' }}</td>
            <td>{{ row.member.member_type_ref.name_en if row.member.member_type_ref else '-' }}</td>
            <td>{{ row.member.created_at.strftime('%Y-%m-%d') if row.member.created_at else '-' }}</td>
            <td class="has-text-right">{{ row.registrations }}</td>
            <td>{{ row.last_registration.strftime('%Y-%m-%d') if row.last_registration else '-' }}</td>
            <td class="has-text-right">{{ "{:,.2f}".format(row.payments_total) }}</td>
            <td>{{ row.last_payment.strftime('%Y-%m-%d') if row.last_payment else '-' }}</td>
          </tr>
          {% else %}
          <tr>
            <td colspan="8" class="has-text-centered has-text-grey">No members found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {% if pagination and pagination.pages > 1 %}
  {% set query_params = 'per_page=' ~ pagination.per_page ~ '&q=' ~ (q or '') ~ '&member_type_id=' ~ (member_type_id or '') ~ '&is_verified=' ~ (verified or '') ~ '&start=' ~ (start_value or '') ~ '&end=' ~ (end_value or '') %}
  <nav class="pagination is-centered" role="navigation" aria-label="pagination">
    <a class="pagination-previous" href="?page={{ pagination.prev_num }}&{{ query_params }}" {% if not pagination.has_prev %}disabled{% endif %}>Previous</a>
    <a class="pagination-next" href="?page={{ pagination.next_num }}&{{ query_params }}" {% if not pagination.has_next %}disabled{% endif %}>Next</a>
    <ul class="pagination-list">
      <li><span class="pagination-link is-current">Page {{ pagination.page }} of {{ pagination.pages }}</span></li>
    </ul>
  </nav>
  {% endif %}
</div>
{% endblock %}

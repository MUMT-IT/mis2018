{% extends "continueing_edu/base_frontend.html" %}

{% block title %}{{ texts.get('payment_process', 'ดำเนินการชำระเงิน' if current_lang == 'th' else 'Payment Process')
}}{% endblock %}

{% block extra_css %}
{{ super() }}
<style>
          :root {
                    --primary-gradient: linear-gradient(135deg, #4338ca 0%, #6366f1 100%);
                    --card-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.10), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
                    --muted-text: #4b5563;
                    --muted-bg: #f9fafb;
                    --border: #e5e7eb;
          }

          .payment-container {
                    max-width: 800px;
                    margin: 3rem auto;
                    padding: 0 1.5rem;
          }

          .payment-header {
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    margin-bottom: 2rem;
          }

          .back-button {
                    display: inline-flex;
                    align-items: center;
                    gap: 0.5rem;
                    color: var(--muted-text);
                    text-decoration: none;
                    font-weight: 500;
                    transition: color 0.2s;
          }

          .back-button:hover {
                    color: #2d3748;
          }

          .modern-card {
                    background: #ffffff;
                    border-radius: 0.5rem;
                    border: 1px solid var(--border);
                    box-shadow: var(--card-shadow);
                    padding: 2rem;
                    margin-bottom: 2rem;
          }

          .card-title {
                    font-size: 1.5rem;
                    font-weight: 700;
                    color: #1f2937;
                    margin-bottom: 0.25rem;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 0.5rem;
          }

          .card-subtitle {
                    text-align: center;
                    color: #6b7280;
                    margin-bottom: 1.25rem;
                    font-size: 0.95rem;
          }

          .event-info {
                    background: var(--muted-bg);
                    border-radius: 0.5rem;
                    border: 1px solid var(--border);
                    padding: 1.5rem;
                    margin-bottom: 2rem;
          }

          .event-info-row {
                    display: flex;
                    justify-content: space-between;
                    margin-bottom: 0.75rem;
          }

          .event-info-row:last-child {
                    margin-bottom: 0;
                    padding-top: 0.75rem;
                    border-top: 2px solid #e2e8f0;
          }

          .event-info-label {
                    color: #4b5563;
                    font-weight: 500;
          }

          .event-info-value {
                    color: #2d3748;
                    font-weight: 600;
          }

          .payment-amount {
                    color: #059669;
                    font-size: 1.5rem;
                    font-weight: 700;
          }

          /* PromptPay QR Code */
          .qr-container {
                    text-align: center;
                    padding: 2rem;
                    background: var(--muted-bg);
                    border-radius: 0.5rem;
                    border: 1px solid var(--border);
                    margin-bottom: 2rem;
          }

          .qr-code-box {
                    background: white;
                    padding: 2rem;
                    border-radius: 0.5rem;
                    display: inline-block;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
          }

          /* PromptPay frame (Thailand-style) */
          .promptpay-frame {
                    width: 320px;
                    max-width: 100%;
                    margin: 0 auto;
                    border: 2px solid #1d4ed8;
                    border-radius: 0.75rem;
                    overflow: hidden;
                    background: #ffffff;
          }

          .promptpay-frame__header {
                    background: linear-gradient(135deg, #1d4ed8 0%, #2563eb 60%, #1e40af 100%);
                    color: #ffffff;
                    padding: 0.6rem 0.9rem;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    gap: 0.75rem;
          }

          .promptpay-frame__brand {
                    display: flex;
                    flex-direction: column;
                    line-height: 1.1;
                    text-align: left;
          }

          .promptpay-frame__brand-en {
                    font-weight: 800;
                    letter-spacing: 0.02em;
                    font-size: 1.05rem;
          }

          .promptpay-frame__brand-th {
                    font-weight: 700;
                    font-size: 0.85rem;
                    opacity: 0.95;
          }

          .promptpay-frame__badge {
                    font-weight: 800;
                    font-size: 0.8rem;
                    padding: 0.25rem 0.5rem;
                    border-radius: 999px;
                    background: rgba(255, 255, 255, 0.16);
                    border: 1px solid rgba(255, 255, 255, 0.25);
                    white-space: nowrap;
          }

          .promptpay-frame__body {
                    background: #ffffff;
                    padding: 1rem;
          }

          .promptpay-frame .qr-code {
                    width: 280px;
                    height: 280px;
                    display: block;
                    margin: 0 auto;
          }

          .qr-code {
                    width: 280px;
                    height: 280px;
                    margin: 0 auto;
          }

          .qr-actions {
                    margin-top: 0.75rem;
                    display: flex;
                    gap: 0.5rem;
                    justify-content: center;
          }

          .btn-ghost {
                    background: transparent;
                    border: 1px solid var(--border);
                    padding: 0.5rem 1rem;
                    border-radius: 0.5rem;
                    cursor: pointer;
          }

          .promptpay-id {
                    font-size: 1.25rem;
                    font-weight: 600;
                    color: #2d3748;
                    margin-top: 1rem;
          }

          /* Bank Transfer Info */
          .bank-info-box {
                    background: var(--muted-bg);
                    border: 1px solid var(--border);
                    border-radius: 0.5rem;
                    padding: 2rem;
                    margin-bottom: 2rem;
          }

          .bank-detail {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 1rem;
                    background: white;
                    border-radius: 0.5rem;
                    margin-bottom: 1rem;
          }

          .bank-detail:last-child {
                    margin-bottom: 0;
          }

          .bank-label {
                    color: #4b5563;
                    font-weight: 500;
          }

          .bank-value {
                    color: #2d3748;
                    font-weight: 700;
                    font-size: 1.125rem;
          }

          .copy-button {
                    background: #4338ca;
                    color: white;
                    border: none;
                    padding: 0.5rem 1rem;
                    border-radius: 0.5rem;
                    cursor: pointer;
                    font-weight: 600;
                    transition: background 0.2s;
          }

          .copy-button:hover {
                    background: #3730a3;
          }

          /* Upload Section */
          .upload-section {
                    background: #fefce8;
                    border: 2px dashed #fbbf24;
                    border-radius: 0.5rem;
                    padding: 2rem;
                    text-align: center;
                    margin-bottom: 2rem;
          }

          .upload-section h3 {
                    color: #92400e;
                    margin-bottom: 1rem;
                    font-size: 1.25rem;
                    font-weight: 700;
          }

          .file-input-wrapper {
                    position: relative;
                    display: inline-block;
                    cursor: pointer;
                    margin-top: 1rem;
          }

          .file-input-wrapper input[type="file"] {
                    display: none;
          }

          .file-input-label {
                    display: inline-block;
                    padding: 0.875rem 2rem;
                    background: #fbbf24;
                    color: #92400e;
                    border-radius: 0.5rem;
                    font-weight: 700;
                    cursor: pointer;
                    transition: background 0.2s;
          }

          .file-input-label:hover {
                    background: #f59e0b;
          }

          .file-name {
                    margin-top: 1rem;
                    color: #92400e;
                    font-weight: 600;
          }

          /* Credit Card Form */
          .card-form {
                    max-width: 500px;
                    margin: 0 auto;
          }

          .form-group {
                    margin-bottom: 1.5rem;
          }

          .form-label {
                    display: block;
                    color: #2d3748;
                    font-weight: 600;
                    margin-bottom: 0.5rem;
          }

          .form-input {
                    width: 100%;
                    padding: 0.875rem 1rem;
                    border: 2px solid #e2e8f0;
                    border-radius: 0.5rem;
                    font-size: 1rem;
                    transition: border-color 0.2s;
          }

          .form-input:focus {
                    outline: none;
                    border-color: #4299e1;
          }

          .form-row {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 1rem;
          }

          /* Counter Service */
          .payment-code-box {
                    background: var(--primary-gradient);
                    color: white;
                    border-radius: 1rem;
                    padding: 2rem;
                    text-align: center;
                    margin-bottom: 2rem;
          }

          .payment-code {
                    font-size: 2.5rem;
                    font-weight: 800;
                    letter-spacing: 0.1em;
                    margin: 1rem 0;
          }

          .payment-code-label {
                    font-size: 1rem;
                    opacity: 0.9;
                    margin-bottom: 0.5rem;
          }

          .instruction-steps {
                    background: var(--muted-bg);
                    border-radius: 0.5rem;
                    border: 1px solid var(--border);
                    padding: 2rem;
                    margin-bottom: 2rem;
          }

          .instruction-step {
                    display: flex;
                    align-items: start;
                    margin-bottom: 1.5rem;
          }

          .instruction-step:last-child {
                    margin-bottom: 0;
          }

          .step-number {
                    width: 32px;
                    height: 32px;
                    background: #4338ca;
                    color: white;
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    font-weight: 700;
                    margin-right: 1rem;
                    flex-shrink: 0;
          }

          .step-content {
                    flex: 1;
                    color: #2d3748;
          }

          .step-title {
                    font-weight: 700;
                    margin-bottom: 0.25rem;
          }

          .step-description {
                    color: #718096;
                    font-size: 0.95rem;
          }

          /* Action Buttons */
          .action-buttons {
                    display: flex;
                    gap: 1rem;
                    margin-top: 2rem;
          }

          .btn-primary {
                    flex: 1;
                    background: var(--primary-gradient);
                    color: white;
                    border: none;
                    padding: 1rem 2rem;
                    border-radius: 0.75rem;
                    font-size: 1.125rem;
                    font-weight: 700;
                    cursor: pointer;
                    transition: transform 0.2s, box-shadow 0.2s;
          }

          .btn-primary:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(67, 56, 202, 0.4);
          }

          .btn-secondary {
                    flex: 1;
                    background: white;
                    color: #4b5563;
                    border: 1px solid #d1d5db;
                    padding: 1rem 2rem;
                    border-radius: 0.5rem;
                    font-size: 1.125rem;
                    font-weight: 700;
                    cursor: pointer;
                    transition: background 0.2s;
          }

          .btn-secondary:hover {
                    background: #f9fafb;
                    border-color: #9ca3af;
          }

          #pp-debug {
                    padding: 0.5rem 0.75rem;
                    border-radius: 0.5rem;
                    background: #eef2ff;
                    color: #1f2937;
                    margin-bottom: 0.75rem;
                    font-weight: 700;
                    border: 1px solid #e0e7ff;
          }

          /* Alert Boxes */
          .alert {
                    padding: 1rem 1.5rem;
                    border-radius: 0.75rem;
                    margin-bottom: 2rem;
          }

          .alert-info {
                    background: #e0f2fe;
                    border-left: 4px solid #0ea5e9;
                    color: #075985;
          }

          .alert-success {
                    background: #d1fae5;
                    border-left: 4px solid #10b981;
                    color: #065f46;
          }

          .alert-warning {
                    background: #fef3c7;
                    border-left: 4px solid #fbbf24;
                    color: #92400e;
          }

          @media (max-width: 768px) {
                    .payment-container {
                              padding: 0 1rem;
                              margin: 2rem auto;
                    }

                    .payment-card {
                              padding: 1.5rem;
                    }

                    .qr-code {
                              width: 220px;
                              height: 220px;
                    }

                    .form-row {
                              grid-template-columns: 1fr;
                    }

                    .action-buttons {
                              flex-direction: column;
                    }
          }
</style>
{% endblock %}

{% block content %}
<div class="payment-container">
          <div class="payment-header">
                    <a href="{{ url_for('continuing_edu.course_detail' if event.event_type=='course' else 'continuing_edu.webinar_detail', course_id=event.id if event.event_type=='course' else None, webinar_id=event.id if event.event_type=='webinar' else None, lang=current_lang) }}"
                              class="back-button">
                              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path d="M19 12H5M12 19l-7-7 7-7" />
                              </svg>
                              <span>{{ texts.get('back', 'ย้อนกลับ' if current_lang == 'th' else 'Back') }}</span>
                    </a>
          </div>

          <div class="modern-card">
                    <div id="pp-debug">SCB QR present: {{ 'yes' if scb_qr_image else 'no' }} &middot; Ref2: {{ scb_ref2
                              or 'n/a' }}</div>

                    <div id="paymentStatusBanner" class="alert alert-warning" style="display:none"></div>
                    <h2 class="card-title">
                              <svg width="28" height="28" viewBox="0 0 24 24" fill="none"
                                        xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 2v20M2 12h20" stroke="#667eea" stroke-width="1.5"
                                                  stroke-linecap="round" stroke-linejoin="round" />
                              </svg>
                              {{ texts.get('payment_process', 'ดำเนินการชำระเงิน' if current_lang == 'th' else 'Payment
                              Process') }}
                    </h2>
                    <p class="card-subtitle">
                              {{ texts.get('complete_payment', 'กรุณาดำเนินการชำระเงินเพื่อยืนยันการลงทะเบียน' if
                              current_lang == 'th' else 'Please complete the payment to confirm your registration') }}
                    </p>

                    <!-- Event Info -->
                    <div class="event-info">
                              <div class="event-info-row">
                                        <span class="event-info-label">{{ texts.get('course_name', 'ชื่อหลักสูตร' if
                                                  current_lang == 'th' else 'Course Name') }}:</span>
                                        <span class="event-info-value">{{ event.title_th if current_lang == 'th' else
                                                  event.title_en }}</span>
                              </div>
                              <div class="event-info-row">
                                        <span class="event-info-label">{{ texts.get('member_name', 'ชื่อผู้ลงทะเบียน' if
                                                  current_lang == 'th' else 'Member Name') }}:</span>
                                        <span class="event-info-value">{{ member.firstname_th }} {{ member.lastname_th
                                                  }}</span>
                              </div>
                              <div class="event-info-row">
                                        <span class="event-info-label">{{ texts.get('payment_amount', 'จำนวนเงิน' if
                                                  current_lang == 'th' else 'Amount') }}:</span>
                                        <span class="event-info-value payment-amount">{{
                                                  "{:,.2f}".format(payment.payment_amount) }} {{ texts.get('baht', 'บาท'
                                                  if current_lang == 'th' else 'THB') }}</span>
                              </div>
                    </div>

                    <!-- Payment Method Specific Content -->
                    {% if payment_method == 'promptpay' %}
                    <!-- PromptPay QR Code -->
                    <div class="alert alert-info">
                              <strong>{{ texts.get('scan_qr', 'สแกน QR Code' if current_lang == 'th' else 'Scan QR
                                        Code') }}</strong><br>
                              {{ texts.get('scan_qr_instruction', 'กรุณาสแกน QR Code
                              ด้านล่างด้วยแอปธนาคารของคุณเพื่อชำระเงิน' if current_lang == 'th' else 'Please scan the QR
                              code below with your banking app to make payment') }}
                    </div>

                    <div class="qr-container">
                              <div class="qr-code-box">
                                        <div class="promptpay-frame" aria-label="PromptPay QR">
                                                  <div class="promptpay-frame__header">
                                                            <div class="promptpay-frame__brand">
                                                                      <div class="promptpay-frame__brand-en">PromptPay
                                                                      </div>
                                                                      <div class="promptpay-frame__brand-th">พร้อมเพย์
                                                                      </div>
                                                            </div>
                                                            <div class="promptpay-frame__badge">QR Payment</div>
                                                  </div>
                                                  <div class="promptpay-frame__body">
                                                            <img id="scbQrImg"
                                                                      src="{% if scb_qr_image %}data:image/png;base64,{{ scb_qr_image }}{% elif payment_qr_url %}{{ payment_qr_url }}?amount={{ payment.payment_amount }}&ref=INV-{{ payment.id }}{% else %}{{ url_for('static', filename='img/QR_for_checking.jpg') }}{% endif %}"
                                                                      alt="PromptPay QR Code" class="qr-code"
                                                                      style="display:block">
                                                  </div>
                                        </div>

                                        <div id="qrPlaceholder" class="qr-code" style="display:none"></div>

                                        {% if (not scb_qr_image) and (not payment_qr_url) %}
                                        <div style="margin-top:0.5rem; color:#64748b; font-weight:600;">
                                                  (Mock QR for layout test)
                                        </div>
                                        {% endif %}

                                        {% if qr_error %}
                                        <div
                                                  style="margin-top:0.5rem; color:#b45309; font-weight:600; white-space: pre-wrap;">
                                                  {{ qr_error }}
                                        </div>
                                        {% endif %}

                                        <div style="margin-top:0.75rem; text-align:left;" id="qrRefs">
                                                  <div><strong>Ref1:</strong> <span id="ref1Span">{{ scb_ref1 or ''
                                                                      }}</span></div>
                                                  <div><strong>Ref2:</strong> <span id="ref2Span">{{ scb_ref2 or ''
                                                                      }}</span></div>
                                        </div>

                                        <div class="qr-actions">
                                                  {% if payment_gateway == 'scb' %}
                                                  <button id="generateQrBtn" class="btn-ghost"
                                                            data-url="{{ url_for('continuing_edu.generate_scb_qrcode', payment_id=payment.id) }}">{{
                                                            texts.get('generate_qr','Generate QR') }}</button>
                                                  <button id="downloadQrBtn" class="btn-ghost" style="display:none;">{{
                                                            texts.get('download','Download') }}</button>
                                                  {% else %}
                                                  <div style="color:#64748b; font-weight:600;">
                                                            SCB gateway not enabled (set
                                                            <code>PAYMENT_GATEWAY=scb</code>)
                                                  </div>
                                                  {% endif %}
                                        </div>

                                        {% if promptpay_id %}
                                        <p class="promptpay-id">{{ texts.get('promptpay_id', 'หมายเลข PromptPay' if
                                                  current_lang == 'th' else 'PromptPay ID') }}: {{ promptpay_id }}</p>
                                        {% endif %}
                              </div>
                    </div>

                    <div class="instruction-steps">
                              <div class="instruction-step">
                                        <div class="step-number">1</div>
                                        <div class="step-content">
                                                  <div class="step-title">{{ texts.get('step1_promptpay',
                                                            'เปิดแอปธนาคาร' if current_lang == 'th' else 'Open your
                                                            banking app') }}</div>
                                                  <div class="step-description">{{ texts.get('step1_promptpay_desc',
                                                            'เปิดแอปพลิเคชันธนาคารบนมือถือของคุณ' if current_lang ==
                                                            'th' else 'Open your mobile banking application') }}</div>
                                        </div>
                              </div>
                              <div class="instruction-step">
                                        <div class="step-number">2</div>
                                        <div class="step-content">
                                                  <div class="step-title">{{ texts.get('step2_promptpay', 'สแกน QR Code'
                                                            if current_lang == 'th' else 'Scan QR Code') }}</div>
                                                  <div class="step-description">{{ texts.get('step2_promptpay_desc',
                                                            'ใช้ฟังก์ชันสแกน QR Code ในแอป' if current_lang == 'th' else
                                                            'Use the QR scan function in your app') }}</div>
                                        </div>
                              </div>
                              <div class="instruction-step">
                                        <div class="step-number">3</div>
                                        <div class="step-content">
                                                  <div class="step-title">{{ texts.get('step3_promptpay',
                                                            'ยืนยันการชำระเงิน' if current_lang == 'th' else 'Confirm
                                                            payment') }}</div>
                                                  <div class="step-description">{{ texts.get('step3_promptpay_desc',
                                                            'ตรวจสอบจำนวนเงินและยืนยันการชำระ' if current_lang == 'th'
                                                            else 'Check the amount and confirm payment') }}</div>
                                        </div>
                              </div>
                              <div class="instruction-step">
                                        <div class="step-number">4</div>
                                        <div class="step-content">
                                                  <div class="step-title">{{ texts.get('step4_promptpay', 'รอการตรวจสอบ'
                                                            if current_lang == 'th' else 'Wait for verification') }}
                                                  </div>
                                                  <div class="step-description">{{ texts.get('step4_promptpay_desc',
                                                            'ระบบจะตรวจสอบการชำระเงินภายใน 1-2 ชั่วโมง' if current_lang
                                                            == 'th' else 'System will verify payment within 1-2 hours')
                                                            }}</div>
                                        </div>
                              </div>
                    </div>

                    {% elif payment_method == 'bank_transfer' %}
                    <!-- Bank Transfer -->
                    <div class="alert alert-info">
                              <strong>{{ texts.get('bank_transfer', 'โอนเงินผ่านธนาคาร' if current_lang == 'th' else
                                        'Bank Transfer') }}</strong><br>
                              {{ texts.get('bank_transfer_instruction', 'กรุณาโอนเงินไปยังบัญชีธนาคารด้านล่าง' if
                              current_lang == 'th' else 'Please transfer to the bank account below') }}
                    </div>

                    <div class="bank-info-box">
                              <h3 style="margin-bottom: 1.5rem; color: #2d3748; font-weight: 700;">{{
                                        texts.get('bank_account_details', 'รายละเอียดบัญชีธนาคาร' if current_lang ==
                                        'th' else 'Bank Account Details') }}</h3>

                              {% if bank_info %}
                              {% set bank_details = bank_info.split('|') %}
                              {% for detail in bank_details %}
                              {% set parts = detail.split(':') %}
                              {% if parts|length == 2 %}
                              <div class="bank-detail">
                                        <div>
                                                  <div class="bank-label">{{ parts[0].strip() }}</div>
                                                  <div class="bank-value">{{ parts[1].strip() }}</div>
                                        </div>
                                        <button class="copy-button" onclick="copyToClipboard('{{ parts[1].strip() }}')">
                                                  {{ texts.get('copy', 'คัดลอก' if current_lang == 'th' else 'Copy') }}
                                        </button>
                              </div>
                              {% endif %}
                              {% endfor %}
                              {% else %}
                              <div class="bank-detail">
                                        <div>
                                                  <div class="bank-label">{{ texts.get('bank_name', 'ธนาคาร' if
                                                            current_lang == 'th' else 'Bank') }}</div>
                                                  <div class="bank-value">{{ texts.get('contact_admin',
                                                            'กรุณาติดต่อเจ้าหน้าที่' if current_lang == 'th' else
                                                            'Please contact administrator') }}</div>
                                        </div>
                              </div>
                              {% endif %}
                    </div>

                    <div class="upload-section">
                              <h3>{{ texts.get('upload_slip', 'อัพโหลดสลิปโอนเงิน' if current_lang == 'th' else 'Upload
                                        Payment Slip') }}</h3>
                              <p style="color: #92400e; margin-bottom: 1rem;">
                                        {{ texts.get('upload_slip_instruction',
                                        'กรุณาอัพโหลดหลักฐานการโอนเงินเพื่อตรวจสอบ' if current_lang == 'th' else 'Please
                                        upload your payment slip for verification') }}
                              </p>
                              <form action="{{ url_for('continuing_edu.upload_payment_slip', payment_id=payment.id, lang=current_lang) }}"
                                        method="post" enctype="multipart/form-data" id="uploadSlipForm">
                                        <div class="file-input-wrapper">
                                                  <input type="file" name="slip" id="slipFile" accept="image/*,.pdf"
                                                            required onchange="showFileName()">
                                                  <label for="slipFile" class="file-input-label">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="20"
                                                                      height="20" viewBox="0 0 24 24" fill="none"
                                                                      stroke="currentColor" stroke-width="2"
                                                                      style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;">
                                                                      <path
                                                                                d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4">
                                                                      </path>
                                                                      <polyline points="17 8 12 3 7 8"></polyline>
                                                                      <line x1="12" y1="3" x2="12" y2="15"></line>
                                                            </svg>
                                                            {{ texts.get('choose_file', 'เลือกไฟล์' if current_lang ==
                                                            'th' else 'Choose File') }}
                                                  </label>
                                        </div>
                                        <div class="file-name" id="fileName"></div>
                              </form>
                    </div>

                    <div class="instruction-steps">
                              <div class="instruction-step">
                                        <div class="step-number">1</div>
                                        <div class="step-content">
                                                  <div class="step-title">{{ texts.get('step1_bank', 'โอนเงินไปยังบัญชี'
                                                            if current_lang == 'th' else 'Transfer to account') }}</div>
                                                  <div class="step-description">{{ texts.get('step1_bank_desc',
                                                            'โอนเงินตามจำนวนที่ระบุไปยังบัญชีธนาคารข้างต้น' if
                                                            current_lang == 'th' else 'Transfer the amount to the bank
                                                            account above') }}</div>
                                        </div>
                              </div>
                              <div class="instruction-step">
                                        <div class="step-number">2</div>
                                        <div class="step-content">
                                                  <div class="step-title">{{ texts.get('step2_bank', 'อัพโหลดสลิป' if
                                                            current_lang == 'th' else 'Upload slip') }}</div>
                                                  <div class="step-description">{{ texts.get('step2_bank_desc',
                                                            'ถ่ายภาพหรือสกรีนช็อตสลิปการโอนแล้วอัพโหลด' if current_lang
                                                            == 'th' else 'Take photo or screenshot of slip and upload')
                                                            }}</div>
                                        </div>
                              </div>
                              <div class="instruction-step">
                                        <div class="step-number">3</div>
                                        <div class="step-content">
                                                  <div class="step-title">{{ texts.get('step3_bank', 'รอการตรวจสอบ' if
                                                            current_lang == 'th' else 'Wait for verification') }}</div>
                                                  <div class="step-description">{{ texts.get('step3_bank_desc',
                                                            'เจ้าหน้าที่จะตรวจสอบภายใน 1-2 วันทำการ' if current_lang ==
                                                            'th' else 'Staff will verify within 1-2 business days') }}
                                                  </div>
                                        </div>
                              </div>
                    </div>

                    {% elif payment_method == 'credit_card' %}
                    <!-- Credit Card -->
                    <div class="alert alert-warning">
                              <strong>{{ texts.get('credit_card_payment', 'ชำระด้วยบัตรเครดิต' if current_lang == 'th'
                                        else 'Credit Card Payment') }}</strong><br>
                              {{ texts.get('credit_card_instruction', 'กรุณากรอกข้อมูลบัตรเครดิตเพื่อทำการชำระเงิน' if
                              current_lang == 'th' else 'Please enter your credit card details to make payment') }}
                    </div>

                    <form action="{{ url_for('continuing_edu.process_credit_card', payment_id=payment.id, lang=current_lang) }}"
                              method="post" class="card-form" id="creditCardForm">
                              <div class="form-group">
                                        <label class="form-label">{{ texts.get('card_number', 'หมายเลขบัตร' if
                                                  current_lang == 'th' else 'Card Number') }}</label>
                                        <input type="text" name="card_number" class="form-input"
                                                  placeholder="1234 5678 9012 3456" maxlength="19" required>
                              </div>

                              <div class="form-group">
                                        <label class="form-label">{{ texts.get('card_holder', 'ชื่อบนบัตร' if
                                                  current_lang == 'th' else 'Cardholder Name') }}</label>
                                        <input type="text" name="card_holder" class="form-input" placeholder="JOHN DOE"
                                                  required>
                              </div>

                              <div class="form-row">
                                        <div class="form-group">
                                                  <label class="form-label">{{ texts.get('expiry_date', 'วันหมดอายุ' if
                                                            current_lang == 'th' else 'Expiry Date') }}</label>
                                                  <input type="text" name="expiry" class="form-input"
                                                            placeholder="MM/YY" maxlength="5" required>
                                        </div>
                                        <div class="form-group">
                                                  <label class="form-label">{{ texts.get('cvv', 'รหัส CVV' if
                                                            current_lang == 'th' else 'CVV') }}</label>
                                                  <input type="text" name="cvv" class="form-input" placeholder="123"
                                                            maxlength="4" required>
                                        </div>
                              </div>
                    </form>

                    <div class="instruction-steps">
                              <div class="instruction-step">
                                        <div class="step-number">1</div>
                                        <div class="step-content">
                                                  <div class="step-title">{{ texts.get('step1_credit', 'กรอกข้อมูลบัตร'
                                                            if current_lang == 'th' else 'Enter card details') }}</div>
                                                  <div class="step-description">{{ texts.get('step1_credit_desc',
                                                            'กรอกข้อมูลบัตรเครดิตให้ครบถ้วน' if current_lang == 'th'
                                                            else 'Fill in all credit card information') }}</div>
                                        </div>
                              </div>
                              <div class="instruction-step">
                                        <div class="step-number">2</div>
                                        <div class="step-content">
                                                  <div class="step-title">{{ texts.get('step2_credit', 'ยืนยัน OTP' if
                                                            current_lang == 'th' else 'Verify OTP') }}</div>
                                                  <div class="step-description">{{ texts.get('step2_credit_desc',
                                                            'กรอกรหัส OTP ที่ส่งไปยังเบอร์โทรศัพท์' if current_lang ==
                                                            'th' else 'Enter OTP sent to your phone') }}</div>
                                        </div>
                              </div>
                              <div class="instruction-step">
                                        <div class="step-number">3</div>
                                        <div class="step-content">
                                                  <div class="step-title">{{ texts.get('step3_credit', 'ระบบดำเนินการ'
                                                            if current_lang == 'th' else 'Processing') }}</div>
                                                  <div class="step-description">{{ texts.get('step3_credit_desc',
                                                            'รอสักครู่ระบบกำลังตรวจสอบการชำระเงิน' if current_lang ==
                                                            'th' else 'Please wait while processing payment') }}</div>
                                        </div>
                              </div>
                              <div class="instruction-step">
                                        <div class="step-number">4</div>
                                        <div class="step-content">
                                                  <div class="step-title">{{ texts.get('step4_credit', 'รับใบเสร็จ' if
                                                            current_lang == 'th' else 'Receive receipt') }}</div>
                                                  <div class="step-description">{{ texts.get('step4_credit_desc',
                                                            'ระบบจะส่งใบเสร็จไปยังอีเมล' if current_lang == 'th' else
                                                            'Receipt will be sent to your email') }}</div>
                                        </div>
                              </div>
                    </div>

                    {% elif payment_method == 'counter' %}
                    <!-- Counter Service -->
                    <div class="alert alert-info">
                              <strong>{{ texts.get('counter_service', 'ชำระที่เคาน์เตอร์' if current_lang == 'th' else
                                        'Counter Service') }}</strong><br>
                              {{ texts.get('counter_instruction', 'นำรหัสชำระเงินด้านล่างไปชำระที่เคาน์เตอร์' if
                              current_lang == 'th' else 'Bring the payment code below to pay at counter') }}
                    </div>

                    <div class="payment-code-box">
                              <div class="payment-code-label">{{ texts.get('payment_code', 'รหัสชำระเงิน' if
                                        current_lang == 'th' else 'Payment Code') }}</div>
                              <div class="payment-code">INV-{{ payment.id }}</div>
                              <div style="font-size: 0.9rem; opacity: 0.9;">{{ texts.get('show_at_counter',
                                        'แสดงรหัสนี้ที่เคาน์เตอร์บริการ' if current_lang == 'th' else 'Show this code at
                                        service counter') }}</div>
                    </div>

                    <div class="instruction-steps">
                              <div class="instruction-step">
                                        <div class="step-number">1</div>
                                        <div class="step-content">
                                                  <div class="step-title">{{ texts.get('step1_counter',
                                                            'พิมพ์หรือจดรหัส' if current_lang == 'th' else 'Print or
                                                            note the code') }}</div>
                                                  <div class="step-description">{{ texts.get('step1_counter_desc',
                                                            'บันทึกรหัสชำระเงินหรือจับภาพหน้าจอ' if current_lang == 'th'
                                                            else 'Save payment code or take screenshot') }}</div>
                                        </div>
                              </div>
                              <div class="instruction-step">
                                        <div class="step-number">2</div>
                                        <div class="step-content">
                                                  <div class="step-title">{{ texts.get('step2_counter',
                                                            'ชำระที่เคาน์เตอร์' if current_lang == 'th' else 'Pay at
                                                            counter') }}</div>
                                                  <div class="step-description">{{ texts.get('step2_counter_desc',
                                                            'นำรหัสไปชำระที่เคาน์เตอร์บริการ' if current_lang == 'th'
                                                            else 'Bring code to service counter for payment') }}</div>
                                        </div>
                              </div>
                              <div class="instruction-step">
                                        <div class="step-number">3</div>
                                        <div class="step-content">
                                                  <div class="step-title">{{ texts.get('step3_counter', 'รับใบเสร็จ' if
                                                            current_lang == 'th' else 'Receive receipt') }}</div>
                                                  <div class="step-description">{{ texts.get('step3_counter_desc',
                                                            'เก็บใบเสร็จที่ได้รับจากเจ้าหน้าที่' if current_lang == 'th'
                                                            else 'Keep the receipt from staff') }}</div>
                                        </div>
                              </div>
                              <div class="instruction-step">
                                        <div class="step-number">4</div>
                                        <div class="step-content">
                                                  <div class="step-title">{{ texts.get('step4_counter', 'อัพโหลดใบเสร็จ'
                                                            if current_lang == 'th' else 'Upload receipt') }}</div>
                                                  <div class="step-description">{{ texts.get('step4_counter_desc',
                                                            'ถ่ายภาพใบเสร็จและอัพโหลดในระบบ' if current_lang == 'th'
                                                            else 'Take photo of receipt and upload to system') }}</div>
                                        </div>
                              </div>
                    </div>

                    <div class="upload-section">
                              <h3>{{ texts.get('upload_receipt', 'อัพโหลดใบเสร็จ' if current_lang == 'th' else 'Upload
                                        Receipt') }}</h3>
                              <p style="color: #92400e; margin-bottom: 1rem;">
                                        {{ texts.get('upload_receipt_instruction', 'อัพโหลดหลังจากชำระเงินแล้ว' if
                                        current_lang == 'th' else 'Upload after payment completed') }}
                              </p>
                              <form action="{{ url_for('continuing_edu.upload_payment_slip', payment_id=payment.id, lang=current_lang) }}"
                                        method="post" enctype="multipart/form-data" id="uploadReceiptForm">
                                        <div class="file-input-wrapper">
                                                  <input type="file" name="slip" id="receiptFile" accept="image/*,.pdf"
                                                            onchange="showReceiptName()">
                                                  <label for="receiptFile" class="file-input-label">
                                                            <svg xmlns="http://www.w3.org/2000/svg" width="20"
                                                                      height="20" viewBox="0 0 24 24" fill="none"
                                                                      stroke="currentColor" stroke-width="2"
                                                                      style="display: inline-block; vertical-align: middle; margin-right: 0.5rem;">
                                                                      <path
                                                                                d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4">
                                                                      </path>
                                                                      <polyline points="17 8 12 3 7 8"></polyline>
                                                                      <line x1="12" y1="3" x2="12" y2="15"></line>
                                                            </svg>
                                                            {{ texts.get('choose_file', 'เลือกไฟล์' if current_lang ==
                                                            'th' else 'Choose File') }}
                                                  </label>
                                        </div>
                                        <div class="file-name" id="receiptName"></div>
                              </form>
                    </div>
                    {% endif %}

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                              {% if payment_method == 'bank_transfer' %}
                              <button type="button" class="btn-secondary"
                                        onclick="window.location.href='{{ url_for('continuing_edu.my_payments', lang=current_lang) }}'">
                                        {{ texts.get('back_to_payments', 'กลับไปหน้าชำระเงิน' if current_lang == 'th'
                                        else 'Back to Payments') }}
                              </button>
                              <button type="submit" form="uploadSlipForm" class="btn-primary">
                                        {{ texts.get('upload_slip', 'อัพโหลดสลิป' if current_lang == 'th' else 'Upload
                                        Slip') }}
                              </button>
                              {% elif payment_method == 'credit_card' %}
                              <button type="button" class="btn-secondary"
                                        onclick="window.location.href='{{ url_for('continuing_edu.my_payments', lang=current_lang) }}'">
                                        {{ texts.get('cancel', 'ยกเลิก' if current_lang == 'th' else 'Cancel') }}
                              </button>
                              <button type="submit" form="creditCardForm" class="btn-primary">
                                        {{ texts.get('pay_now', 'ชำระเงิน' if current_lang == 'th' else 'Pay Now') }}
                              </button>
                              {% elif payment_method == 'counter' %}
                              <button type="button" class="btn-secondary" onclick="window.print()">
                                        {{ texts.get('print_code', 'พิมพ์รหัส' if current_lang == 'th' else 'Print
                                        Code') }}
                              </button>
                              <button type="submit" form="uploadReceiptForm" class="btn-primary">
                                        {{ texts.get('upload_receipt', 'อัพโหลดใบเสร็จ' if current_lang == 'th' else
                                        'Upload Receipt') }}
                              </button>
                              {% else %}
                              <button type="button" class="btn-secondary"
                                        onclick="window.location.href='{{ url_for('continuing_edu.my_payments', lang=current_lang) }}'">
                                        {{ texts.get('view_my_payments', 'ดูรายการชำระเงิน' if current_lang == 'th' else
                                        'View My Payments') }}
                              </button>
                              <button type="button" class="btn-primary" onclick="checkPaymentStatus()">
                                        {{ texts.get('check_status', 'ตรวจสอบสถานะ' if current_lang == 'th' else 'Check
                                        Status') }}
                              </button>
                              {% endif %}
                    </div>
          </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
          const paymentStatusBanner = document.getElementById('paymentStatusBanner');

          function setBanner(type, message) {
                    if (!paymentStatusBanner) return;
                    paymentStatusBanner.className = 'alert ' + type;
                    paymentStatusBanner.textContent = message;
                    paymentStatusBanner.style.display = 'block';
          }

          function copyToClipboard(text) {
                    navigator.clipboard.writeText(text).then(function () {
                              alert('{{ texts.get('copied', 'คัดลอกแล้ว' if current_lang == 'th' else 'Copied!') }}');
                    });
          }

          function showFileName() {
                    const input = document.getElementById('slipFile');
                    const fileName = document.getElementById('fileName');
                    if (input && input.files && input.files.length > 0) {
                              fileName.textContent = '{{ texts.get('selected_file', 'ไฟล์ที่เลือก' if current_lang == 'th' else 'Selected file') }}: ' + input.files[0].name;
                    }
          }

          function showReceiptName() {
                    const input = document.getElementById('receiptFile');
                    const fileName = document.getElementById('receiptName');
                    if (input && input.files && input.files.length > 0) {
                              fileName.textContent = '{{ texts.get('selected_file', 'ไฟล์ที่เลือก' if current_lang == 'th' else 'Selected file') }}: ' + input.files[0].name;
                    }
          }

          function checkPaymentStatus() {
                    window.location.href = '{{ url_for('continuing_edu.my_payments', lang=current_lang) }}';
          }

          // Poll backend for payment status (every 3–5 seconds)
          const statusUrl = '{{ url_for('continuing_edu.payment_status_api', payment_id=payment.id, lang=current_lang) }}';
          let pollTimer = null;

          async function pollPaymentStatusOnce() {
                    try {
                              const resp = await fetch(statusUrl, { method: 'GET', headers: { 'Accept': 'application/json' } });
                              const data = await resp.json();
                              if (!resp.ok) {
                                        setBanner('alert-warning', (data && data.message) ? data.message : 'Unable to check payment status');
                                        return;
                              }

                              if (data.is_paid) {
                                        setBanner('alert-success', '{{ texts.get('payment_success', 'ชำระเงินสำเร็จ' if current_lang == 'th' else 'Payment successful') }}');
                                        if (pollTimer) {
                                                  clearTimeout(pollTimer);
                                                  pollTimer = null;
                                        }
                                        const nextUrl = data.next_url || '{{ url_for('continuing_edu.my_payments', lang=current_lang) }}';
                                        setTimeout(() => { window.location.href = nextUrl; }, 800);
                              } else {
                                        setBanner('alert-info', '{{ texts.get('waiting_payment', 'รอการชำระเงิน...ระบบจะตรวจสอบอัตโนมัติ' if current_lang == 'th' else 'Waiting for payment... checking automatically') }}');
                              }
                    } catch (e) {
                              setBanner('alert-warning', 'Error checking payment status: ' + e);
                    }
          }

          function scheduleNextPoll() {
                    const delay = 3000 + Math.floor(Math.random() * 2000);
                    pollTimer = setTimeout(async () => {
                              await pollPaymentStatusOnce();
                              scheduleNextPoll();
                    }, delay);
          }

          // Start polling only on PromptPay page
          const shouldPoll = {{ 'true' if payment_method == 'promptpay' else 'false' }};
          if (shouldPoll) {
                    // show initial banner
                    setBanner('alert-info', '{{ texts.get('waiting_payment', 'รอการชำระเงิน...ระบบจะตรวจสอบอัตโนมัติ' if current_lang == 'th' else 'Waiting for payment... checking automatically') }}');
                    // first tick quickly, then schedule
                    pollPaymentStatusOnce().then(() => scheduleNextPoll());
          }

          // Auto-format credit card number
          const cardNumberInput = document.querySelector('input[name="card_number"]');
          if (cardNumberInput) {
                    cardNumberInput.addEventListener('input', function (e) {
                              let value = e.target.value.replace(/\s/g, '');
                              let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
                              e.target.value = formattedValue;
                    });
          }

          // Auto-format expiry date
          const expiryInput = document.querySelector('input[name="expiry"]');
          if (expiryInput) {
                    expiryInput.addEventListener('input', function (e) {
                              let value = e.target.value.replace(/\D/g, '');
                              if (value.length >= 2) {
                                        value = value.slice(0, 2) + '/' + value.slice(2, 4);
                              }
                              e.target.value = value;
                    });
          }

          // Only allow numbers in CVV
          const cvvInput = document.querySelector('input[name="cvv"]');
          if (cvvInput) {
                    cvvInput.addEventListener('input', function (e) {
                              e.target.value = e.target.value.replace(/\D/g, '');
                    });
          }

          // Generate SCB QR on demand
          const generateBtn = document.getElementById('generateQrBtn');
          const scbImg = document.getElementById('scbQrImg');
          const qrPlaceholder = document.getElementById('qrPlaceholder');
          const ref1Span = document.getElementById('ref1Span');
          const ref2Span = document.getElementById('ref2Span');
          const downloadBtn = document.getElementById('downloadQrBtn');
          async function generateScbQr() {
                    const url = generateBtn?.getAttribute('data-url');
                    if (!url) return;
                    generateBtn.disabled = true;
                    generateBtn.textContent = '{{ texts.get('generating','Generating...') }}';
                    try {
                              const resp = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
                              const data = await resp.json();
                              if (resp.ok && data.qrImage) {
                                        scbImg.src = 'data:image/png;base64,' + data.qrImage;
                                        scbImg.style.display = 'block';
                                        if (qrPlaceholder) qrPlaceholder.style.display = 'none';
                                        if (ref1Span) ref1Span.textContent = data.ref1 || '';
                                        if (ref2Span) ref2Span.textContent = data.ref2 || '';
                                        if (downloadBtn) downloadBtn.style.display = 'inline-block';
                              } else {
                                        const msg = (data && (data.message || data.error)) ? (data.message || JSON.stringify(data.error)) : JSON.stringify(data);
                                        if (qrPlaceholder) {
                                                  qrPlaceholder.style.display = 'flex';
                                                  qrPlaceholder.innerText = 'Failed to generate QR\n' + msg;
                                        } else {
                                                  alert('Failed to generate QR: ' + msg);
                                        }
                              }
                    } catch (err) {
                              if (qrPlaceholder) {
                                        qrPlaceholder.style.display = 'flex';
                                        qrPlaceholder.innerText = 'Error generating QR\n' + err;
                              } else {
                                        alert('Error: ' + err);
                              }
                    } finally {
                              generateBtn.disabled = false;
                              generateBtn.textContent = '{{ texts.get('generate_qr','Generate QR') }}';
                    }
          }

          if (generateBtn) {
                    generateBtn.addEventListener('click', async function (e) {
                              e.preventDefault();
                              await generateScbQr();
                    });
          }

          // Auto-generate QR if server didn't provide one (only when SCB is enabled)
          const shouldAutoGenerate = {{ 'true' if (payment_method == 'promptpay' and payment_gateway == 'scb' and not scb_qr_image) else 'false' }};
          if (shouldAutoGenerate && generateBtn && scbImg) {
                    // Slight delay so layout is ready
                    setTimeout(() => { generateScbQr(); }, 250);
          }

          if (downloadBtn) {
                    downloadBtn.addEventListener('click', function () {
                              if (!scbImg || !scbImg.src) return;
                              const a = document.createElement('a');
                              a.href = scbImg.src;
                              a.download = 'promptpay-{{ payment.id }}.png';
                              document.body.appendChild(a);
                              a.click();
                              a.remove();
                    });
          }
</script>
{% endblock %}